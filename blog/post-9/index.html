<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>chen blog s091sdaf</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">
  <meta name="author" content="Jeremy Chen">
    
  
  <meta name="theme-name" content="liva-hugo" />
  
  <meta name="generator" content="Hugo 0.139.3">

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://s0914712.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://s0914712.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://s0914712.github.io/images/favicon.png " type="image/x-icon">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-XFZRBQ7BCN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XFZRBQ7BCN');
</script>



</head>
<body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://s0914712.github.io/"><img class="img-fluid"
          src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-instagram"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://s0914712.github.io/"><img class="img-fluid"
            src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/about/">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/blog/">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/contact/">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://s0914712.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/ai%e8%a7%a3%e6%b1%ba%e8%bb%8d%e4%ba%8b%e5%95%8f%e9%a1%8c"
          class="text-primary">Ai解決軍事問題</a>
        
        <h2>只靠每天的架次數預測的Prophet與LSTM 模型</h2>
        <div class="mb-3 post-meta">
          <span>By Jeremy Chen</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>01 December 2024</span>
          
        </div>
        
        <img src="https://s0914712.github.io/images/post/lSTM.jpg" class="img-fluid w-100 mb-4" alt="只靠每天的架次數預測的Prophet與LSTM 模型">
        
        <div class="content mb-5">
          <!-- raw HTML omitted -->
<h2 id="長短期記憶神經網路">長短期記憶神經網路</h2>
<p>當我們在理解一件事情的時候，通常不會每次都從頭開始學習，而是透過既有的知識與記憶來理解當下遇到的問題；事件的發生通常具有連續性，也就是一連串的因果關係，或是一個持續不斷變動的結果。在機器學習模型的發展中，引入這種遞歸 (recurrent) 的概念，是遞歸神經網路與其他神經網路模型 (如 CNN) 相比，較為創新的地方。長短期記憶模型則是改善了遞歸神經網路在長期記憶上的一些不足，因為其強大的辨識能力，可以有效的對上下文產生連結，現在已大量運用在自然語言理解 (例如語音轉文字，翻譯，產生手寫文字)，圖像與影像辨識等應用。
在這邊我先不介紹LSTM的原理，因為這個專案並不是企圖改進LSTM的架構，大家只要知道他是具有理解時間關係的網路結構就可以了，既然prophet 和LSTM 都可以進行時間序列的處理 那我們就使用這兩個做個比較。</p>
<h2 id="meta-prophet-簡介重點在於如何處理時間">Meta Prophet 簡介：重點在於如何處理時間</h2>
<p>Meta Prophet（全名：<strong>Facebook Prophet</strong>）是一款專門用於<strong>時間序列預測</strong>的開源工具，由 Facebook（Meta）開發。它以 Python 和 R 實作，設計目標是讓<strong>非專業統計人員</strong>也能輕鬆處理帶有季節性與節慶效應的時間序列數據。Prophet 被廣泛應用在營收、網站流量、銷售、需求等數據預測領域。</p>
<hr>
<h3 id="prophet-的核心概念與架構">Prophet 的核心概念與架構</h3>
<p>Prophet 將時間序列建模公式拆成三大部分：
[
y(t) = g(t) + s(t) + h(t) + \epsilon_t
]</p>
<ul>
<li><strong>g(t)</strong>：trend（趨勢）</li>
<li><strong>s(t)</strong>：seasonality（季節性成分）</li>
<li><strong>h(t)</strong>：holidays（節日或特殊事件）</li>
<li><strong>ε</strong>：雜訊</li>
</ul>
<hr>
<h3 id="prophet-處理時間的關鍵特點">Prophet 處理時間的關鍵特點</h3>
<h3 id="1-自動識別時間欄位">1. 自動識別「時間」欄位</h3>
<p>Prophet 要求資料有兩個欄位：</p>
<ul>
<li><code>ds</code>（datestamp，日期/時間）</li>
<li><code>y</code>（數值）</li>
</ul>
<p>它會自動將 <code>ds</code> 欄位辨識為<strong>時間軸</strong>，並用它進行所有的分解與運算。</p>
<h3 id="2-趨勢trend建模">2. 趨勢（Trend）建模</h3>
<p>Prophet 支持兩種主要趨勢建模方式：</p>
<ul>
<li><strong>線性趨勢</strong>（可設定 changepoints 轉折點）</li>
<li><strong>logistic 增長</strong>（適合有上限的數據，如市場飽和）</li>
</ul>
<p>Prophet 會在時間軸上自動尋找可能出現轉折（changepoints）的時刻，允許趨勢在不同時期改變成長率。</p>
<h3 id="3-週期季節性seasonality">3. 週期/季節性（Seasonality）</h3>
<p>Prophet 會自動加入<strong>年、週、日</strong>等週期性成分，透過傅立葉級數進行建模。你可以手動新增更多週期（如每月），或調整週期的強度。</p>
<h3 id="4-節日事件">4. 節日/事件</h3>
<p>你可以自訂「節日」時間清單（如農曆年、雙 11 等），Prophet 會自動在這些時間點上套用額外的預測效果（如特定天數的異常波動）。</p>
<h3 id="5-處理缺漏值與不規則間距">5. 處理缺漏值與不規則間距</h3>
<p>Prophet 可直接處理<strong>缺漏資料</strong>與<strong>不等間隔</strong>的時間序列，不需手動補齊時間軸。</p>
<h3 id="6-時間格式彈性">6. 時間格式彈性</h3>
<p>支援多種時間格式（日期、日期時間、timestamp），Prophet 會自動解析。</p>
<h3 id="7-可擴展未來的時間軸">7. 可擴展未來的時間軸</h3>
<p>你只需告訴 Prophet 要預測幾天/幾週/幾個月後的數值，它會自動根據 trend 和 seasonality 外推時間序列。</p>
<hr>
<h2 id="prophet-處理時間序列的步驟python-範例">Prophet 處理時間序列的步驟（Python 範例）</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> prophet <span style="color:#f92672">import</span> Prophet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 資料格式要求</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># df 必須包含兩個欄位：ds（日期），y（數值）</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;ds&#39;</span>: pd<span style="color:#f92672">.</span>date_range(<span style="color:#e6db74">&#39;2023-01-01&#39;</span>, periods<span style="color:#f92672">=</span><span style="color:#ae81ff">100</span>),
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;y&#39;</span>: [ <span style="color:#f92672">...</span> ]  <span style="color:#75715e"># 你的數值</span>
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 建立模型</span>
</span></span><span style="display:flex;"><span>m <span style="color:#f92672">=</span> Prophet()
</span></span><span style="display:flex;"><span>m<span style="color:#f92672">.</span>fit(df)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 預測未來 30 天</span>
</span></span><span style="display:flex;"><span>future <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>make_future_dataframe(periods<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>)
</span></span><span style="display:flex;"><span>forecast <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 繪圖</span>
</span></span><span style="display:flex;"><span>fig <span style="color:#f92672">=</span> m<span style="color:#f92672">.</span>plot(forecast)
</span></span></code></pre></div><hr>
<h2 id="prophet-vs-lstm時間處理方式比較總結">Prophet vs. LSTM：時間處理方式比較總結</h2>
<table>
  <thead>
      <tr>
          <th>處理特點</th>
          <th><strong>Prophet</strong></th>
          <th><strong>LSTM</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>1. 時間格式解析</strong></td>
          <td>自動辨識 <code>ds</code> 欄位的時間格式（日期、datetime、timestamp 等）</td>
          <td>時間需手動轉換為連續數值或標準化後的時間特徵</td>
      </tr>
      <tr>
          <td><strong>2. 趨勢、季節性建模</strong></td>
          <td>內建趨勢與多重季節性建模邏輯（如年、週、日）<!-- raw HTML omitted -->可外加節日等事件效應</td>
          <td>不會自動建模趨勢與季節性，需透過大量訓練數據學出時間模式</td>
      </tr>
      <tr>
          <td><strong>3. 缺漏資料處理</strong></td>
          <td>可直接處理不連續與缺漏資料，不需補齊時間軸</td>
          <td>缺值需事先補齊，並要求固定間距的時間序列輸入</td>
      </tr>
      <tr>
          <td><strong>4. 未來預測方式</strong></td>
          <td>明確定義未來時間點，自動產生未來時間序列並套用模型外推</td>
          <td>需遞迴地逐步預測下一時間點，常使用前一步預測作為下一步輸入</td>
      </tr>
      <tr>
          <td><strong>5. 時間粒度調整</strong></td>
          <td>可輕鬆切換日、週、月等粒度</td>
          <td>時間粒度需在特徵工程階段預先設計</td>
      </tr>
      <tr>
          <td><strong>6. 複雜性與需求</strong></td>
          <td>適合小資料量、具明顯週期性與事件驅動的商業場景</td>
          <td>適合大量數據、複雜長期依賴問題（如語音、股價等非週期性應用）</td>
      </tr>
      <tr>
          <td><img src="../../images/post/LSTM.png" alt="image"></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td><img src="../../images/post/PROPHET.png" alt="image"></td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>算出來結果差不多</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>##下面實戰</td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;使用PROPHET 以及LSTM預測總架次數.ipynb
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Automatically generated by Colab.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">Original file is located at
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    https://colab.research.google.com/drive/1rRZQvGW2IOwRO1i1FZd_wGhz5iagkko6
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># @title</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 設定分割日 mday</span>
</span></span><span style="display:flex;"><span>mday <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(<span style="color:#e6db74">&#39;2023-10-1&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 建立訓練用 index 與驗證用 index</span>
</span></span><span style="display:flex;"><span>train_index <span style="color:#f92672">=</span> df2[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">&lt;</span> mday
</span></span><span style="display:flex;"><span>test_index <span style="color:#f92672">=</span> df2[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">&gt;=</span> mday
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 分割輸入資料</span>
</span></span><span style="display:flex;"><span>x_train <span style="color:#f92672">=</span> df2[train_index]
</span></span><span style="display:flex;"><span>x_test <span style="color:#f92672">=</span> df2[test_index]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 分割日期資料（用於繪製圖形）</span>
</span></span><span style="display:flex;"><span>dates_test <span style="color:#f92672">=</span> df2[<span style="color:#e6db74">&#39;ds&#39;</span>][test_index]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;&#34;&#34;### Read DATA&#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 直接使用CSV檔案的URL</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;https://docs.google.com/spreadsheets/d/1hkHrnbn5oQPPHfBhiuieUzmVjsqW20XmRQWkhfWMomE/export?format=csv&amp;id=1hkHrnbn5oQPPHfBhiuieUzmVjsqW20XmRQWkhfWMomE&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 使用pandas讀取CSV</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 顯示DataFrame的前幾行</span>
</span></span><span style="display:flex;"><span>df<span style="color:#f92672">.</span>head()
</span></span><span style="display:flex;"><span>df<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;calendar.csv&#39;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 讀取原始 CSV 檔案</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;/content/calender.csv&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 確保日期格式正確</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(df[<span style="color:#e6db74">&#39;pla_aircraft_sorties&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 可以在這裡進行轉換，例如改欄位名稱、格式等</span>
</span></span><span style="display:flex;"><span>df<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;pla_aircraft_sorties&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>}, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)  <span style="color:#75715e"># 轉為 Prophet 格式範例</span>
</span></span><span style="display:flex;"><span>df<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;date&#39;</span>: <span style="color:#e6db74">&#39;DATE&#39;</span>}, inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)  <span style="color:#75715e"># 轉為 Prophet 格式範例</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 儲存為新的 CSV 檔案</span>
</span></span><span style="display:flex;"><span>df<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">&#39;/content/output.csv&#39;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> datetime <span style="color:#f92672">import</span> datetime
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">convert_for_prophet</span>(input_file, output_file):
</span></span><span style="display:flex;"><span>    df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(input_file)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>columns<span style="color:#f92672">.</span>str<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    df[<span style="color:#e6db74">&#39;DATE&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(df[<span style="color:#e6db74">&#39;DATE&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prophet_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame()
</span></span><span style="display:flex;"><span>    prophet_df[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#39;DATE&#39;</span>]
</span></span><span style="display:flex;"><span>    prophet_df[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">=</span>df[<span style="color:#e6db74">&#39;value&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prophet_df[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">=</span> prophet_df[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#39;%Y-%m-</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prophet_df <span style="color:#f92672">=</span> prophet_df<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#39;ds&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    prophet_df<span style="color:#f92672">.</span>to_csv(output_file, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Save File </span><span style="color:#e6db74">{</span>output_file<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    print(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Preview：&#34;</span>)
</span></span><span style="display:flex;"><span>    print(prophet_df<span style="color:#f92672">.</span>head())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> prophet_df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>input_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;output.csv&#39;</span>
</span></span><span style="display:flex;"><span>output_file <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;DEXVZUS_out.csv&#39;</span>
</span></span><span style="display:flex;"><span>prophet_df <span style="color:#f92672">=</span> convert_for_prophet(input_file, output_file)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">!</span>pip install prophet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Quandl for financial analysis, pandas and numpy for data manipulation</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># fbprophet for additive models, #pytrends for Google trend data</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> prophet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># matplotlib pyplot for plotting</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Class for analyzing and (attempting) to predict future prices</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Contains a number of visualizations and analysis methods</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Stocker</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Initialization requires a ticker symbol</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> __init__(self, price):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>symbol <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;the &#39;</span>
</span></span><span style="display:flex;"><span>        s <span style="color:#f92672">=</span> price
</span></span><span style="display:flex;"><span>        stock <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#39;Date&#39;</span>:s<span style="color:#f92672">.</span>index, <span style="color:#e6db74">&#39;y&#39;</span>:s, <span style="color:#e6db74">&#39;ds&#39;</span>:s<span style="color:#f92672">.</span>index, <span style="color:#e6db74">&#39;close&#39;</span>:s,<span style="color:#e6db74">&#39;open&#39;</span>:s}, index<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#e6db74">&#39;Adj. Close&#39;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> stock<span style="color:#f92672">.</span>columns):
</span></span><span style="display:flex;"><span>            stock[<span style="color:#e6db74">&#39;Adj. Close&#39;</span>] <span style="color:#f92672">=</span> stock[<span style="color:#e6db74">&#39;close&#39;</span>]
</span></span><span style="display:flex;"><span>            stock[<span style="color:#e6db74">&#39;Adj. Open&#39;</span>] <span style="color:#f92672">=</span> stock[<span style="color:#e6db74">&#39;open&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stock[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">=</span> stock[<span style="color:#e6db74">&#39;Adj. Close&#39;</span>]
</span></span><span style="display:flex;"><span>        stock[<span style="color:#e6db74">&#39;Daily Change&#39;</span>] <span style="color:#f92672">=</span> stock[<span style="color:#e6db74">&#39;Adj. Close&#39;</span>] <span style="color:#f92672">-</span> stock[<span style="color:#e6db74">&#39;Adj. Open&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Data assigned as class attribute</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>stock <span style="color:#f92672">=</span> stock<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Minimum and maximum date in range</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_date <span style="color:#f92672">=</span> min(stock[<span style="color:#e6db74">&#39;ds&#39;</span>])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">=</span> max(stock[<span style="color:#e6db74">&#39;ds&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find max and min prices and dates on which they occurred</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_price <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>max(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;y&#39;</span>])
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_price <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>min(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;y&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_price_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>min_price][<span style="color:#e6db74">&#39;ds&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>min_price_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>min_price_date[self<span style="color:#f92672">.</span>min_price_date<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_price_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">==</span> self<span style="color:#f92672">.</span>max_price][<span style="color:#e6db74">&#39;ds&#39;</span>]
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>max_price_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_price_date[self<span style="color:#f92672">.</span>max_price_date<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The starting price (starting with the opening price)</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>starting_price <span style="color:#f92672">=</span> float(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Adj. Open&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># The most recent price</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>most_recent_price <span style="color:#f92672">=</span> float(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>iloc[len(self<span style="color:#f92672">.</span>stock) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Whether or not to round dates</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>round_dates <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Number of years of data to train on</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>training_years <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Prophet parameters</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default prior from library</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>changepoint_prior_scale <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>weekly_seasonality <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>daily_seasonality <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>monthly_seasonality <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>yearly_seasonality <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>changepoints <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> Stocker Initialized. Data covers </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>symbol,
</span></span><span style="display:flex;"><span>                                                                     self<span style="color:#f92672">.</span>min_date,
</span></span><span style="display:flex;"><span>                                                                     self<span style="color:#f92672">.</span>max_date))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Make sure start and end dates are in the range and can be
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    converted to pandas datetimes. Returns dates in the correct format
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">handle_dates</span>(self, start_date, end_date):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default start and end date are the beginning and end of data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            start_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>min_date
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Convert to pandas datetime for indexing dataframe</span>
</span></span><span style="display:flex;"><span>            start_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(start_date)
</span></span><span style="display:flex;"><span>            end_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Enter valid pandas date format.&#39;</span>)
</span></span><span style="display:flex;"><span>            print(e)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>        valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># User will continue to enter dates until valid dates are met</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> (<span style="color:#f92672">not</span> valid_start) <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">not</span> valid_end):
</span></span><span style="display:flex;"><span>            valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>            valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">&lt;</span> start_date:
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;End Date must be later than start date.&#39;</span>)
</span></span><span style="display:flex;"><span>                start_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(<span style="color:#e6db74">&#39;Enter a new start date: &#39;</span>))
</span></span><span style="display:flex;"><span>                end_date<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(<span style="color:#e6db74">&#39;Enter a new end date: &#39;</span>))
</span></span><span style="display:flex;"><span>                valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>                valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">&gt;</span> self<span style="color:#f92672">.</span>max_date:
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#39;End Date exceeds data range&#39;</span>)
</span></span><span style="display:flex;"><span>                    end_date<span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(<span style="color:#e6db74">&#39;Enter a new end date: &#39;</span>))
</span></span><span style="display:flex;"><span>                    valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> start_date <span style="color:#f92672">&lt;</span> self<span style="color:#f92672">.</span>min_date:
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#39;Start Date is before date range&#39;</span>)
</span></span><span style="display:flex;"><span>                    start_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(<span style="color:#e6db74">&#39;Enter a new start date: &#39;</span>))
</span></span><span style="display:flex;"><span>                    valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> start_date, end_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    Return the dataframe trimmed to the specified range.
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">make_df</span>(self, start_date, end_date, df<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default is to use the object stock data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> df:
</span></span><span style="display:flex;"><span>            df <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_date, end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_dates(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># keep track of whether the start and end dates are in the data</span>
</span></span><span style="display:flex;"><span>        start_in <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>        end_in <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If user wants to round dates (default behavior)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>round_dates:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Record if start and end date are in df</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (start_date <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                start_in <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (end_date <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                end_in <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># If both are not in dataframe, round both</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (<span style="color:#f92672">not</span> end_in) <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">not</span> start_in):
</span></span><span style="display:flex;"><span>                trim_df <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                             (df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># If both are in dataframe, round neither</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (end_in) <span style="color:#f92672">&amp;</span> (start_in):
</span></span><span style="display:flex;"><span>                    trim_df <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                                 (df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># If only start is missing, round start</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">not</span> start_in):
</span></span><span style="display:flex;"><span>                        trim_df <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                                     (df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e"># If only end is imssing round end</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">elif</span> (<span style="color:#f92672">not</span> end_in):
</span></span><span style="display:flex;"><span>                        trim_df <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                                     (df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;</span> end_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (<span style="color:#f92672">not</span> valid_start) <span style="color:#f92672">&amp;</span> (<span style="color:#f92672">not</span> valid_end):
</span></span><span style="display:flex;"><span>                start_date, end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_dates(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># No round dates, if either data not in, print message and return</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (start_date <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                    valid_start <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (end_date <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                    valid_end <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Check to make sure dates are in the data</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (start_date <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#39;Start Date not in data (either out of range or not a trading day.)&#39;</span>)
</span></span><span style="display:flex;"><span>                    start_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(prompt<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Enter a new start date: &#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">elif</span> (end_date <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> list(df[<span style="color:#e6db74">&#39;Date&#39;</span>])):
</span></span><span style="display:flex;"><span>                    print(<span style="color:#e6db74">&#39;End Date not in data (either out of range or not a trading day.)&#39;</span>)
</span></span><span style="display:flex;"><span>                    end_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(input(prompt<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Enter a new end date: &#39;</span>) )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Dates are not rounded</span>
</span></span><span style="display:flex;"><span>            trim_df <span style="color:#f92672">=</span> df[(df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                         (df[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> trim_df
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Basic Historical Plots and Basic Statistics</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_stock</span>(self, start_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, end_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, stats<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Adj. Close&#39;</span>], plot_type<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;basic&#39;</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            start_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>min_date
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        stock_plot <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>make_df(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        colors <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;r&#39;</span>, <span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;g&#39;</span>, <span style="color:#e6db74">&#39;y&#39;</span>, <span style="color:#e6db74">&#39;c&#39;</span>, <span style="color:#e6db74">&#39;m&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, stat <span style="color:#f92672">in</span> enumerate(stats):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            stat_min <span style="color:#f92672">=</span> min(stock_plot[stat])
</span></span><span style="display:flex;"><span>            stat_max <span style="color:#f92672">=</span> max(stock_plot[stat])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            stat_avg <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(stock_plot[stat])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            date_stat_min <span style="color:#f92672">=</span> stock_plot[stock_plot[stat] <span style="color:#f92672">==</span> stat_min][<span style="color:#e6db74">&#39;Date&#39;</span>]
</span></span><span style="display:flex;"><span>            date_stat_min <span style="color:#f92672">=</span> date_stat_min[date_stat_min<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>            date_stat_max <span style="color:#f92672">=</span> stock_plot[stock_plot[stat] <span style="color:#f92672">==</span> stat_max][<span style="color:#e6db74">&#39;Date&#39;</span>]
</span></span><span style="display:flex;"><span>            date_stat_max <span style="color:#f92672">=</span> date_stat_max[date_stat_max<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">0</span>]]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Maximum </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74"> on </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(stat, stat_max, date_stat_max))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Minimum </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74"> on </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(stat, stat_min, date_stat_min))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Current </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74"> on </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(stat, self<span style="color:#f92672">.</span>stock[stat]<span style="color:#f92672">.</span>iloc[len(self<span style="color:#f92672">.</span>stock) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>], self<span style="color:#f92672">.</span>max_date<span style="color:#f92672">.</span>date()))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Percentage y-axis</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> plot_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;pct&#39;</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># Simple Plot</span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;fivethirtyeight&#39;</span>);
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> stat <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;Daily Change&#39;</span>:
</span></span><span style="display:flex;"><span>                    plt<span style="color:#f92672">.</span>plot(stock_plot[<span style="color:#e6db74">&#39;Date&#39;</span>], <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> stock_plot[stat],
</span></span><span style="display:flex;"><span>                         color <span style="color:#f92672">=</span> colors[i], linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.4</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.9</span>,
</span></span><span style="display:flex;"><span>                         label <span style="color:#f92672">=</span> stat)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    plt<span style="color:#f92672">.</span>plot(stock_plot[<span style="color:#e6db74">&#39;Date&#39;</span>], <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> (stock_plot[stat] <span style="color:#f92672">-</span>  stat_avg) <span style="color:#f92672">/</span> stat_avg,
</span></span><span style="display:flex;"><span>                         color <span style="color:#f92672">=</span> colors[i], linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.4</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.9</span>,
</span></span><span style="display:flex;"><span>                         label <span style="color:#f92672">=</span> stat)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Change Relative to Average (%)&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Currency History&#39;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>symbol);
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>:<span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>grid(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Stat y-axis</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">elif</span> plot_type <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;basic&#39;</span>:
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;fivethirtyeight&#39;</span>);
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>plot(stock_plot[<span style="color:#e6db74">&#39;Date&#39;</span>], stock_plot[stat], color <span style="color:#f92672">=</span> colors[i], linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, label <span style="color:#f92672">=</span> stat, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>)
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;US $&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Currency History&#39;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>symbol);
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>:<span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>                plt<span style="color:#f92672">.</span>grid(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.4</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Reset the plotting parameters to clear style formatting</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Not sure if this should be a static method</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@staticmethod</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset_plot</span>():
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Restore default parameters</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams<span style="color:#f92672">.</span>update(matplotlib<span style="color:#f92672">.</span>rcParamsDefault)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Adjust a few parameters to liking</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;figure.figsize&#39;</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;axes.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;xtick.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;ytick.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;axes.titlesize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;text.color&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Method to linearly interpolate prices on the weekends</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">resample</span>(self, dataframe):
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Change the index and resample at daily level</span>
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>set_index(<span style="color:#e6db74">&#39;ds&#39;</span>)
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Reset the index and interpolate nan values</span>
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>interpolate()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dataframe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Remove weekends from a dataframe</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_weekends</span>(self, dataframe):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Reset index to use ix</span>
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        weekends <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find all of the weekends</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, date <span style="color:#f92672">in</span> enumerate(dataframe[<span style="color:#e6db74">&#39;ds&#39;</span>]):
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (date<span style="color:#f92672">.</span>weekday()) <span style="color:#f92672">==</span> <span style="color:#ae81ff">5</span> <span style="color:#f92672">|</span> (date<span style="color:#f92672">.</span>weekday() <span style="color:#f92672">==</span> <span style="color:#ae81ff">6</span>):
</span></span><span style="display:flex;"><span>                weekends<span style="color:#f92672">.</span>append(i)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Drop the weekends</span>
</span></span><span style="display:flex;"><span>        dataframe <span style="color:#f92672">=</span> dataframe<span style="color:#f92672">.</span>drop(weekends, axis<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dataframe
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Calculate and plot profit from buying and holding shares for specified date range</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">buy_and_hold</span>(self, start_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, end_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, nshares<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_date, end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_dates(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find starting and ending price of stock</span>
</span></span><span style="display:flex;"><span>        start_price <span style="color:#f92672">=</span> float(self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">==</span> start_date][<span style="color:#e6db74">&#39;Adj. Open&#39;</span>])
</span></span><span style="display:flex;"><span>        end_price <span style="color:#f92672">=</span> float(self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">==</span> end_date][<span style="color:#e6db74">&#39;Adj. Close&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make a profit dataframe and calculate profit column</span>
</span></span><span style="display:flex;"><span>        profits <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>make_df(start_date, end_date)
</span></span><span style="display:flex;"><span>        profits[<span style="color:#e6db74">&#39;hold_profit&#39;</span>] <span style="color:#f92672">=</span> nshares <span style="color:#f92672">*</span> (profits[<span style="color:#e6db74">&#39;Adj. Close&#39;</span>] <span style="color:#f92672">-</span> start_price)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Total profit</span>
</span></span><span style="display:flex;"><span>        total_hold_profit <span style="color:#f92672">=</span> nshares <span style="color:#f92672">*</span> (end_price <span style="color:#f92672">-</span> start_price)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> Total buy and hold profit from </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> for </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> shares = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format
</span></span><span style="display:flex;"><span>              (self<span style="color:#f92672">.</span>symbol, start_date, end_date, nshares, total_hold_profit))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the total profits</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;dark_background&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Location for number of profit</span>
</span></span><span style="display:flex;"><span>        text_location <span style="color:#f92672">=</span> (end_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(months <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the profits over time</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(profits[<span style="color:#e6db74">&#39;Date&#39;</span>], profits[<span style="color:#e6db74">&#39;hold_profit&#39;</span>], <span style="color:#e6db74">&#39;b&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Profit ($)&#39;</span>); plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Buy and Hold Profits for </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>                                                                self<span style="color:#f92672">.</span>symbol, start_date, end_date))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Display final value on graph</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>text(x <span style="color:#f92672">=</span> text_location,
</span></span><span style="display:flex;"><span>             y <span style="color:#f92672">=</span>  total_hold_profit <span style="color:#f92672">+</span> (total_hold_profit <span style="color:#f92672">/</span> <span style="color:#ae81ff">40</span>),
</span></span><span style="display:flex;"><span>             s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> total_hold_profit,
</span></span><span style="display:flex;"><span>            color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#66d9ef">if</span> total_hold_profit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>            size <span style="color:#f92672">=</span> <span style="color:#ae81ff">14</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>grid(alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create a prophet model without training</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_model</span>(self):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make the model</span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> prophet<span style="color:#f92672">.</span>Prophet(daily_seasonality<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>daily_seasonality,
</span></span><span style="display:flex;"><span>                                  weekly_seasonality<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>weekly_seasonality,
</span></span><span style="display:flex;"><span>                                  yearly_seasonality<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>yearly_seasonality,
</span></span><span style="display:flex;"><span>                                  changepoint_prior_scale<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>changepoint_prior_scale,
</span></span><span style="display:flex;"><span>                                  changepoints<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>changepoints)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>monthly_seasonality:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Add monthly seasonality</span>
</span></span><span style="display:flex;"><span>            model<span style="color:#f92672">.</span>add_seasonality(name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;monthly&#39;</span>, period <span style="color:#f92672">=</span> <span style="color:#ae81ff">30.5</span>, fourier_order <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Graph the effects of altering the changepoint prior scale (cps)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">changepoint_prior_analysis</span>(self, changepoint_priors<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0.001</span>, <span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>], colors<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;b&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>, <span style="color:#e6db74">&#39;grey&#39;</span>, <span style="color:#e6db74">&#39;gold&#39;</span>]):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Training and plotting with specified years of data</span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (max(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>]
</span></span><span style="display:flex;"><span>                                                     ) <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training_years)))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Iterate through all the changepoints and make models</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, prior <span style="color:#f92672">in</span> enumerate(changepoint_priors):
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Select the changepoint</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>changepoint_prior_scale <span style="color:#f92672">=</span> prior
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create and train a model with the specified cps</span>
</span></span><span style="display:flex;"><span>            model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>            model<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods<span style="color:#f92672">=</span><span style="color:#ae81ff">180</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Make a dataframe to hold predictions</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> i <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>                predictions <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Fill in prediction dataframe</span>
</span></span><span style="display:flex;"><span>            predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat_upper&#39;</span> <span style="color:#f92672">%</span> prior] <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>]
</span></span><span style="display:flex;"><span>            predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat_lower&#39;</span> <span style="color:#f92672">%</span> prior] <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>]
</span></span><span style="display:flex;"><span>            predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat&#39;</span> <span style="color:#f92672">%</span> prior] <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;yhat&#39;</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove the weekends</span>
</span></span><span style="display:flex;"><span>        predictions <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>remove_weekends(predictions)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot set-up</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;fivethirtyeight&#39;</span>)
</span></span><span style="display:flex;"><span>        fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Actual observations</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>plot(train[<span style="color:#e6db74">&#39;ds&#39;</span>], train[<span style="color:#e6db74">&#39;y&#39;</span>], <span style="color:#e6db74">&#39;ko&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Observations&#39;</span>)
</span></span><span style="display:flex;"><span>        color_dict <span style="color:#f92672">=</span> {prior: color <span style="color:#66d9ef">for</span> prior, color <span style="color:#f92672">in</span> zip(changepoint_priors, colors)}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot each of the changepoint predictions</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> prior <span style="color:#f92672">in</span> changepoint_priors:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the predictions themselves</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>plot(predictions[<span style="color:#e6db74">&#39;ds&#39;</span>], predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat&#39;</span> <span style="color:#f92672">%</span> prior], linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.2</span>,
</span></span><span style="display:flex;"><span>                     color <span style="color:#f92672">=</span> color_dict[prior], label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74"> prior scale&#39;</span> <span style="color:#f92672">%</span> prior)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the uncertainty interval</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>fill_between(predictions[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat_upper&#39;</span> <span style="color:#f92672">%</span> prior],
</span></span><span style="display:flex;"><span>                            predictions[<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%.3f</span><span style="color:#e6db74">_yhat_lower&#39;</span> <span style="color:#f92672">%</span> prior], facecolor <span style="color:#f92672">=</span> color_dict[prior],
</span></span><span style="display:flex;"><span>                            alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.3</span>, edgecolor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.6</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot labels</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Stock Price ($)&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Effect of Changepoint Prior Scale&#39;</span>);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Basic prophet model for specified number of days</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_prophet_model</span>(self, days<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, resample<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Fit on the stock history for self.training_years number of years</span>
</span></span><span style="display:flex;"><span>        stock_history <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">-</span>
</span></span><span style="display:flex;"><span>                                                         pd<span style="color:#f92672">.</span>DateOffset(years <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>training_years))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> resample:
</span></span><span style="display:flex;"><span>            stock_history <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>resample(stock_history)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>fit(stock_history)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make and predict for next year with future dataframe</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods <span style="color:#f92672">=</span> days, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> days <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Print the predicted price</span>
</span></span><span style="display:flex;"><span>            predicted_date <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            predicted_value <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;yhat&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Predicted Index on </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(predicted_date, predicted_value))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Historical and Predicted bolivars Index&#39;</span>  <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>symbol
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>            title <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Historical and Modeled bolivars Index&#39;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>symbol
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set up the plot</span>
</span></span><span style="display:flex;"><span>        fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the actual values</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>plot(stock_history[<span style="color:#e6db74">&#39;ds&#39;</span>], stock_history[<span style="color:#e6db74">&#39;y&#39;</span>], <span style="color:#e6db74">&#39;ko-&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.4</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Observations&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the predicted values</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>plot(future[<span style="color:#e6db74">&#39;ds&#39;</span>], future[<span style="color:#e6db74">&#39;yhat&#39;</span>], <span style="color:#e6db74">&#39;forestgreen&#39;</span>,linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.4</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Modeled&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the uncertainty interval as ribbon</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>fill_between(np<span style="color:#f92672">.</span>array(future[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime()),
</span></span><span style="display:flex;"><span>                future[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>],
</span></span><span style="display:flex;"><span>                future[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>],
</span></span><span style="display:flex;"><span>                alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, facecolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;g&#39;</span>, edgecolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;k&#39;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1.4</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot formatting</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">10</span>}); plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Index $&#39;</span>);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>grid(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.6</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>title(title);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> model, future
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Evaluate prediction model for one year</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">evaluate_prediction</span>(self, start_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, end_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, nshares <span style="color:#f92672">=</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default start date is one year before end of data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default end date is end date of data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            start_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_date, end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_dates(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Training data starts self.training_years years before start date and goes up to start date</span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;</span> start_date) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>                           (self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (start_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training_years)))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Testing data is specified in the range</span>
</span></span><span style="display:flex;"><span>        test <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span> (self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create and train the model</span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Make a future dataframe and predictions</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods <span style="color:#f92672">=</span> <span style="color:#ae81ff">365</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Merge predictions with the known values</span>
</span></span><span style="display:flex;"><span>        test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(test, future, on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(train, future, on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate the differences between consecutive measurements</span>
</span></span><span style="display:flex;"><span>        test[<span style="color:#e6db74">&#39;pred_diff&#39;</span>] <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;yhat&#39;</span>]<span style="color:#f92672">.</span>diff()
</span></span><span style="display:flex;"><span>        test[<span style="color:#e6db74">&#39;real_diff&#39;</span>] <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>diff()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Correct is when we predicted the correct direction</span>
</span></span><span style="display:flex;"><span>        test[<span style="color:#e6db74">&#39;correct&#39;</span>] <span style="color:#f92672">=</span> (np<span style="color:#f92672">.</span>sign(test[<span style="color:#e6db74">&#39;pred_diff&#39;</span>]) <span style="color:#f92672">==</span> np<span style="color:#f92672">.</span>sign(test[<span style="color:#e6db74">&#39;real_diff&#39;</span>])) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Accuracy when we predict increase and decrease</span>
</span></span><span style="display:flex;"><span>        increase_accuracy <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>mean(test[test[<span style="color:#e6db74">&#39;pred_diff&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;correct&#39;</span>])
</span></span><span style="display:flex;"><span>        decrease_accuracy <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>mean(test[test[<span style="color:#e6db74">&#39;pred_diff&#39;</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>][<span style="color:#e6db74">&#39;correct&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate mean absolute error</span>
</span></span><span style="display:flex;"><span>        test_errors <span style="color:#f92672">=</span> abs(test[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">-</span> test[<span style="color:#e6db74">&#39;yhat&#39;</span>])
</span></span><span style="display:flex;"><span>        test_mean_error <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(test_errors)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train_errors <span style="color:#f92672">=</span> abs(train[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">-</span> train[<span style="color:#e6db74">&#39;yhat&#39;</span>])
</span></span><span style="display:flex;"><span>        train_mean_error <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(train_errors)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate percentage of time actual value within prediction range</span>
</span></span><span style="display:flex;"><span>        test[<span style="color:#e6db74">&#39;in_range&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#66d9ef">False</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> test<span style="color:#f92672">.</span>index:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (test[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">&lt;</span> test[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>]<span style="color:#f92672">.</span>iloc[i]) <span style="color:#f92672">&amp;</span> (test[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">&gt;</span> test[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>]<span style="color:#f92672">.</span>iloc[i]):
</span></span><span style="display:flex;"><span>                test[<span style="color:#e6db74">&#39;in_range&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> <span style="color:#66d9ef">True</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        in_range_accuracy <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> np<span style="color:#f92672">.</span>mean(test[<span style="color:#e6db74">&#39;in_range&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> nshares:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Date range of predictions</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Prediction Range: </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(start_date,
</span></span><span style="display:flex;"><span>                end_date))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Final prediction vs actual value</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Predicted price on </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(max(future[<span style="color:#e6db74">&#39;ds&#39;</span>]), future[<span style="color:#e6db74">&#39;yhat&#39;</span>]<span style="color:#f92672">.</span>iloc[len(future) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Actual price on    </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(max(test[<span style="color:#e6db74">&#39;ds&#39;</span>]), test[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>iloc[len(test) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Average Absolute Error on Training Data = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(train_mean_error))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;Average Absolute Error on Testing  Data = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(test_mean_error))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Direction accuracy</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;When the model predicted an increase, the price increased </span><span style="color:#e6db74">{:.2f}% o</span><span style="color:#e6db74">f the time.&#39;</span><span style="color:#f92672">.</span>format(increase_accuracy))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;When the model predicted a  decrease, the price decreased  </span><span style="color:#e6db74">{:.2f}% o</span><span style="color:#e6db74">f the time.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(decrease_accuracy))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;The actual value was within the </span><span style="color:#e6db74">{:d}% c</span><span style="color:#e6db74">onfidence interval </span><span style="color:#e6db74">{:.2f}% o</span><span style="color:#e6db74">f the time.&#39;</span><span style="color:#f92672">.</span>format(int(<span style="color:#ae81ff">100</span> <span style="color:#f92672">*</span> model<span style="color:#f92672">.</span>interval_width), in_range_accuracy))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>             <span style="color:#75715e"># Reset the plot</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Set up the plot</span>
</span></span><span style="display:flex;"><span>            fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the actual values</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>plot(train[<span style="color:#e6db74">&#39;ds&#39;</span>], train[<span style="color:#e6db74">&#39;y&#39;</span>], <span style="color:#e6db74">&#39;ko-&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.4</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Observations&#39;</span>)
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>plot(test[<span style="color:#e6db74">&#39;ds&#39;</span>], test[<span style="color:#e6db74">&#39;y&#39;</span>], <span style="color:#e6db74">&#39;ko-&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.4</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Observations&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the predicted values</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>plot(future[<span style="color:#e6db74">&#39;ds&#39;</span>], future[<span style="color:#e6db74">&#39;yhat&#39;</span>], <span style="color:#e6db74">&#39;navy&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.4</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Predicted&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the uncertainty interval as ribbon</span>
</span></span><span style="display:flex;"><span>            ax<span style="color:#f92672">.</span>fill_between(future[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), future[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>], future[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>], alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.6</span>,
</span></span><span style="display:flex;"><span>                           facecolor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;gold&#39;</span>, edgecolor <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.4</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Confidence Interval&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Put a vertical line at the start of predictions</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>vlines(x<span style="color:#f92672">=</span>min(test[<span style="color:#e6db74">&#39;ds&#39;</span>]), ymin<span style="color:#f92672">=</span>min(future[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>]), ymax<span style="color:#f92672">=</span>max(future[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>]), colors <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                       linestyles<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dashed&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Prediction Start&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot formatting</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">8</span>}); plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Price $&#39;</span>);
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>grid(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">0.6</span>, alpha <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.6</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> Model Evaluation from </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>symbol,
</span></span><span style="display:flex;"><span>                start_date, end_date));
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>show();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># If a number of shares is specified, play the game</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">elif</span> nshares:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Only playing the stocks when we predict the stock will increase</span>
</span></span><span style="display:flex;"><span>            test_pred_increase <span style="color:#f92672">=</span> test[test[<span style="color:#e6db74">&#39;pred_diff&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            test_pred_increase<span style="color:#f92672">.</span>reset_index(inplace<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>            prediction_profit <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Iterate through all the predictions and calculate profit from playing</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> i, correct <span style="color:#f92672">in</span> enumerate(test_pred_increase[<span style="color:#e6db74">&#39;correct&#39;</span>]):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># If we predicted up and the price goes up, we gain the difference</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> correct <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>:
</span></span><span style="display:flex;"><span>                    prediction_profit<span style="color:#f92672">.</span>append(nshares <span style="color:#f92672">*</span> test_pred_increase[<span style="color:#e6db74">&#39;real_diff&#39;</span>]<span style="color:#f92672">.</span>iloc[i])
</span></span><span style="display:flex;"><span>                <span style="color:#75715e"># If we predicted up and the price goes down, we lose the difference</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>                    prediction_profit<span style="color:#f92672">.</span>append(nshares <span style="color:#f92672">*</span> test_pred_increase[<span style="color:#e6db74">&#39;real_diff&#39;</span>]<span style="color:#f92672">.</span>iloc[i])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            test_pred_increase[<span style="color:#e6db74">&#39;pred_profit&#39;</span>] <span style="color:#f92672">=</span> prediction_profit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Put the profit into the test dataframe</span>
</span></span><span style="display:flex;"><span>            test <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(test, test_pred_increase[[<span style="color:#e6db74">&#39;ds&#39;</span>, <span style="color:#e6db74">&#39;pred_profit&#39;</span>]], on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;left&#39;</span>)
</span></span><span style="display:flex;"><span>            test[<span style="color:#e6db74">&#39;pred_profit&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Profit for either method at all dates</span>
</span></span><span style="display:flex;"><span>            test[<span style="color:#e6db74">&#39;pred_profit&#39;</span>] <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;pred_profit&#39;</span>]<span style="color:#f92672">.</span>cumsum()<span style="color:#f92672">.</span>ffill()
</span></span><span style="display:flex;"><span>            test[<span style="color:#e6db74">&#39;hold_profit&#39;</span>] <span style="color:#f92672">=</span> nshares <span style="color:#f92672">*</span> (test[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">-</span> float(test[<span style="color:#e6db74">&#39;y&#39;</span>]<span style="color:#f92672">.</span>iloc[<span style="color:#ae81ff">0</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Display information</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;You played the stock market in </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> from </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> with </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> shares.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(
</span></span><span style="display:flex;"><span>                self<span style="color:#f92672">.</span>symbol, start_date, end_date, nshares))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;When the model predicted an increase, the price increased </span><span style="color:#e6db74">{:.2f}% o</span><span style="color:#e6db74">f the time.&#39;</span><span style="color:#f92672">.</span>format(increase_accuracy))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;When the model predicted a  decrease, the price decreased  </span><span style="color:#e6db74">{:.2f}% o</span><span style="color:#e6db74">f the time.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(decrease_accuracy))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Display some friendly information about the perils of playing the stock market</span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;The total profit using the Prophet model = $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(np<span style="color:#f92672">.</span>sum(prediction_profit)))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;The Buy and Hold strategy profit =         $</span><span style="color:#e6db74">{:.2f}</span><span style="color:#e6db74">.&#39;</span><span style="color:#f92672">.</span>format(float(test[<span style="color:#e6db74">&#39;hold_profit&#39;</span>]<span style="color:#f92672">.</span>iloc[len(test) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])))
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Thanks for playing the stock market!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the predicted and actual profits over time</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Final profit and final smart used for locating text</span>
</span></span><span style="display:flex;"><span>            final_profit <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;pred_profit&#39;</span>]<span style="color:#f92672">.</span>iloc[len(test) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            final_smart <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;hold_profit&#39;</span>]<span style="color:#f92672">.</span>iloc[len(test) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># text location</span>
</span></span><span style="display:flex;"><span>            last_date <span style="color:#f92672">=</span> test[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>iloc[len(test) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            text_location <span style="color:#f92672">=</span> (last_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(months <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;dark_background&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot smart profits</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(test[<span style="color:#e6db74">&#39;ds&#39;</span>], test[<span style="color:#e6db74">&#39;hold_profit&#39;</span>], <span style="color:#e6db74">&#39;b&#39;</span>,
</span></span><span style="display:flex;"><span>                     linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Buy and Hold Strategy&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot prediction profits</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(test[<span style="color:#e6db74">&#39;ds&#39;</span>], test[<span style="color:#e6db74">&#39;pred_profit&#39;</span>],
</span></span><span style="display:flex;"><span>                     color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#66d9ef">if</span> final_profit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                     linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1.8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Prediction Strategy&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Display final values on graph</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>text(x <span style="color:#f92672">=</span> text_location,
</span></span><span style="display:flex;"><span>                     y <span style="color:#f92672">=</span>  final_profit <span style="color:#f92672">+</span> (final_profit <span style="color:#f92672">/</span> <span style="color:#ae81ff">40</span>),
</span></span><span style="display:flex;"><span>                     s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> final_profit,
</span></span><span style="display:flex;"><span>                    color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#66d9ef">if</span> final_profit <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>text(x <span style="color:#f92672">=</span> text_location,
</span></span><span style="display:flex;"><span>                     y <span style="color:#f92672">=</span>  final_smart <span style="color:#f92672">+</span> (final_smart <span style="color:#f92672">/</span> <span style="color:#ae81ff">40</span>),
</span></span><span style="display:flex;"><span>                     s <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;$</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> final_smart,
</span></span><span style="display:flex;"><span>                    color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;g&#39;</span> <span style="color:#66d9ef">if</span> final_smart <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                    size <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot formatting</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Profit  (US $)&#39;</span>); plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>);
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Predicted versus Buy and Hold Profits&#39;</span>);
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">10</span>});
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>grid(alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.2</span>);
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">retrieve_google_trends</span>(self, search, date_range):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set up the trend fetching object</span>
</span></span><span style="display:flex;"><span>        pytrends <span style="color:#f92672">=</span> TrendReq(hl<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;en-US&#39;</span>, tz<span style="color:#f92672">=</span><span style="color:#ae81ff">360</span>)
</span></span><span style="display:flex;"><span>        kw_list <span style="color:#f92672">=</span> [search]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create the search object</span>
</span></span><span style="display:flex;"><span>            pytrends<span style="color:#f92672">.</span>build_payload(kw_list, cat<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, timeframe<span style="color:#f92672">=</span>date_range[<span style="color:#ae81ff">0</span>], geo<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;&#39;</span>, gprop<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;news&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Retrieve the interest over time</span>
</span></span><span style="display:flex;"><span>            trends <span style="color:#f92672">=</span> pytrends<span style="color:#f92672">.</span>interest_over_time()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            related_queries <span style="color:#f92672">=</span> pytrends<span style="color:#f92672">.</span>related_queries()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">except</span> <span style="color:#a6e22e">Exception</span> <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Google Search Trend retrieval failed.&#39;</span>)
</span></span><span style="display:flex;"><span>            print(e)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> trends, related_queries
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">changepoint_date_analysis</span>(self, search<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use past self.training_years years of data</span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>training_years))]
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Predictions of the training data (no future periods)</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(train, future[[<span style="color:#e6db74">&#39;ds&#39;</span>, <span style="color:#e6db74">&#39;yhat&#39;</span>]], on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        changepoints <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>changepoints
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>reset_index(drop<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Create dataframe of only changepoints</span>
</span></span><span style="display:flex;"><span>        change_indices <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> changepoint <span style="color:#f92672">in</span> (changepoints):
</span></span><span style="display:flex;"><span>            change_indices<span style="color:#f92672">.</span>append(train[train[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">==</span> changepoint]<span style="color:#f92672">.</span>index[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        c_data <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>iloc[change_indices, :]
</span></span><span style="display:flex;"><span>        deltas <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>params[<span style="color:#e6db74">&#39;delta&#39;</span>][<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        c_data[<span style="color:#e6db74">&#39;delta&#39;</span>] <span style="color:#f92672">=</span> deltas
</span></span><span style="display:flex;"><span>        c_data[<span style="color:#e6db74">&#39;abs_delta&#39;</span>] <span style="color:#f92672">=</span> abs(c_data[<span style="color:#e6db74">&#39;delta&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Sort the values by maximum change</span>
</span></span><span style="display:flex;"><span>        c_data <span style="color:#f92672">=</span> c_data<span style="color:#f92672">.</span>sort_values(by<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;abs_delta&#39;</span>, ascending<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Limit to 10 largest changepoints</span>
</span></span><span style="display:flex;"><span>        c_data <span style="color:#f92672">=</span> c_data[:<span style="color:#ae81ff">10</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Separate into negative and positive changepoints</span>
</span></span><span style="display:flex;"><span>        cpos_data <span style="color:#f92672">=</span> c_data[c_data[<span style="color:#e6db74">&#39;delta&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        cneg_data <span style="color:#f92672">=</span> c_data[c_data[<span style="color:#e6db74">&#39;delta&#39;</span>] <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Changepoints and data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> search:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Changepoints sorted by slope rate of change (2nd derivative):</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            print(c_data[[<span style="color:#e6db74">&#39;Date&#39;</span>, <span style="color:#e6db74">&#39;Adj. Close&#39;</span>, <span style="color:#e6db74">&#39;delta&#39;</span>]][:<span style="color:#ae81ff">5</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Line plot showing actual values, estimated values, and changepoints</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Set up line plot</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(train[<span style="color:#e6db74">&#39;ds&#39;</span>], train[<span style="color:#e6db74">&#39;y&#39;</span>], <span style="color:#e6db74">&#39;ko&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Stock Price&#39;</span>)
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(future[<span style="color:#e6db74">&#39;ds&#39;</span>], future[<span style="color:#e6db74">&#39;yhat&#39;</span>], color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;navy&#39;</span>, linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2.0</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Modeled&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Changepoints as vertical lines</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>vlines(cpos_data[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), ymin <span style="color:#f92672">=</span> min(train[<span style="color:#e6db74">&#39;y&#39;</span>]), ymax <span style="color:#f92672">=</span> max(train[<span style="color:#e6db74">&#39;y&#39;</span>]),
</span></span><span style="display:flex;"><span>                       linestyles<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dashed&#39;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                       linewidth<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Negative Changepoints&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>vlines(cneg_data[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), ymin <span style="color:#f92672">=</span> min(train[<span style="color:#e6db74">&#39;y&#39;</span>]), ymax <span style="color:#f92672">=</span> max(train[<span style="color:#e6db74">&#39;y&#39;</span>]),
</span></span><span style="display:flex;"><span>                       linestyles<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dashed&#39;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;darkgreen&#39;</span>,
</span></span><span style="display:flex;"><span>                       linewidth<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Positive Changepoints&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>:<span style="color:#ae81ff">10</span>});
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Price ($)&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Stock Price with Changepoints&#39;</span>)
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Search for search term in google news</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Show related queries, rising related queries</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Graph changepoints, search frequency, stock price</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> search:
</span></span><span style="display:flex;"><span>            date_range <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (str(min(train[<span style="color:#e6db74">&#39;Date&#39;</span>])), str(max(train[<span style="color:#e6db74">&#39;Date&#39;</span>])))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Get the Google Trends for specified terms and join to training dataframe</span>
</span></span><span style="display:flex;"><span>            trends, related_queries <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>retrieve_google_trends(search, date_range)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (trends <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>)  <span style="color:#f92672">or</span> (related_queries <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>):
</span></span><span style="display:flex;"><span>                print(<span style="color:#e6db74">&#39;No search trends found for </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> search)
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Top Related Queries: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            print(related_queries[search][<span style="color:#e6db74">&#39;top&#39;</span>]<span style="color:#f92672">.</span>head())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74"> Rising Related Queries: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>            print(related_queries[search][<span style="color:#e6db74">&#39;rising&#39;</span>]<span style="color:#f92672">.</span>head())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Upsample the data for joining with training data</span>
</span></span><span style="display:flex;"><span>            trends <span style="color:#f92672">=</span> trends<span style="color:#f92672">.</span>resample(<span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            trends <span style="color:#f92672">=</span> trends<span style="color:#f92672">.</span>reset_index(level<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>            trends <span style="color:#f92672">=</span> trends<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;date&#39;</span>: <span style="color:#e6db74">&#39;ds&#39;</span>, search: <span style="color:#e6db74">&#39;freq&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Interpolate the frequency</span>
</span></span><span style="display:flex;"><span>            trends[<span style="color:#e6db74">&#39;freq&#39;</span>] <span style="color:#f92672">=</span> trends[<span style="color:#e6db74">&#39;freq&#39;</span>]<span style="color:#f92672">.</span>interpolate()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Merge with the training data</span>
</span></span><span style="display:flex;"><span>            train <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(train, trends, on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Normalize values</span>
</span></span><span style="display:flex;"><span>            train[<span style="color:#e6db74">&#39;y_norm&#39;</span>] <span style="color:#f92672">=</span> train[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">/</span> max(train[<span style="color:#e6db74">&#39;y&#39;</span>])
</span></span><span style="display:flex;"><span>            train[<span style="color:#e6db74">&#39;freq_norm&#39;</span>] <span style="color:#f92672">=</span> train[<span style="color:#e6db74">&#39;freq&#39;</span>] <span style="color:#f92672">/</span> max(train[<span style="color:#e6db74">&#39;freq&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot the normalized stock price and normalize search frequency</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(train[<span style="color:#e6db74">&#39;ds&#39;</span>], train[<span style="color:#e6db74">&#39;y_norm&#39;</span>], <span style="color:#e6db74">&#39;k-&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Stock Price&#39;</span>)
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>plot(train[<span style="color:#e6db74">&#39;ds&#39;</span>], train[<span style="color:#e6db74">&#39;freq_norm&#39;</span>], color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;goldenrod&#39;</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Search Frequency&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Changepoints as vertical lines</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>vlines(cpos_data[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), ymin <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, ymax <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                       linestyles<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dashed&#39;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;r&#39;</span>,
</span></span><span style="display:flex;"><span>                       linewidth<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Negative Changepoints&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>vlines(cneg_data[<span style="color:#e6db74">&#39;ds&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), ymin <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, ymax <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>                       linestyles<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;dashed&#39;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;darkgreen&#39;</span>,
</span></span><span style="display:flex;"><span>                       linewidth<span style="color:#f92672">=</span> <span style="color:#ae81ff">1.2</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Positive Changepoints&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Plot formatting</span>
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Normalized Values&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;</span><span style="color:#e6db74">%s</span><span style="color:#e6db74"> Stock Price and Search Frequency for </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> (self<span style="color:#f92672">.</span>symbol, search))
</span></span><span style="display:flex;"><span>            plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Predict the future price for a given range of days</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">predict_future</span>(self, days<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Use past self.training_years years for training</span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (max(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>]
</span></span><span style="display:flex;"><span>                                                    ) <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training_years))]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Future dataframe with specified number of days to predict</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods<span style="color:#f92672">=</span>days, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Only concerned with future dates</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> future[future[<span style="color:#e6db74">&#39;ds&#39;</span>] <span style="color:#f92672">&gt;=</span> max(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>])]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Remove the weekends</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>remove_weekends(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Calculate whether increase or not</span>
</span></span><span style="display:flex;"><span>        future[<span style="color:#e6db74">&#39;diff&#39;</span>] <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;yhat&#39;</span>]<span style="color:#f92672">.</span>diff()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span>dropna()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Find the prediction direction and create separate dataframes</span>
</span></span><span style="display:flex;"><span>        future[<span style="color:#e6db74">&#39;direction&#39;</span>] <span style="color:#f92672">=</span> (future[<span style="color:#e6db74">&#39;diff&#39;</span>] <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Rename the columns for presentation</span>
</span></span><span style="display:flex;"><span>        future <span style="color:#f92672">=</span> future<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;ds&#39;</span>: <span style="color:#e6db74">&#39;Date&#39;</span>, <span style="color:#e6db74">&#39;yhat&#39;</span>: <span style="color:#e6db74">&#39;estimate&#39;</span>, <span style="color:#e6db74">&#39;diff&#39;</span>: <span style="color:#e6db74">&#39;change&#39;</span>,
</span></span><span style="display:flex;"><span>                                        <span style="color:#e6db74">&#39;yhat_upper&#39;</span>: <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;yhat_lower&#39;</span>: <span style="color:#e6db74">&#39;lower&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        future_increase <span style="color:#f92672">=</span> future[future[<span style="color:#e6db74">&#39;direction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>        future_decrease <span style="color:#f92672">=</span> future[future[<span style="color:#e6db74">&#39;direction&#39;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Print out the dates</span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Predicted Increase: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        print(future_increase[[<span style="color:#e6db74">&#39;Date&#39;</span>, <span style="color:#e6db74">&#39;estimate&#39;</span>, <span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;lower&#39;</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Predicted Decrease: </span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>        print(future_decrease[[<span style="color:#e6db74">&#39;Date&#39;</span>, <span style="color:#e6db74">&#39;estimate&#39;</span>, <span style="color:#e6db74">&#39;change&#39;</span>, <span style="color:#e6db74">&#39;upper&#39;</span>, <span style="color:#e6db74">&#39;lower&#39;</span>]])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Set up plot</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>style<span style="color:#f92672">.</span>use(<span style="color:#e6db74">&#39;fivethirtyeight&#39;</span>)
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;axes.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;xtick.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;ytick.labelsize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>        matplotlib<span style="color:#f92672">.</span>rcParams[<span style="color:#e6db74">&#39;axes.titlesize&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the predictions and indicate if increase or decrease</span>
</span></span><span style="display:flex;"><span>        fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot the estimates</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>plot(future_increase[<span style="color:#e6db74">&#39;Date&#39;</span>], future_increase[<span style="color:#e6db74">&#39;estimate&#39;</span>], <span style="color:#e6db74">&#39;g^&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Pred. Increase&#39;</span>)
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>plot(future_decrease[<span style="color:#e6db74">&#39;Date&#39;</span>], future_decrease[<span style="color:#e6db74">&#39;estimate&#39;</span>], <span style="color:#e6db74">&#39;rv&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Pred. Decrease&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot errorbars</span>
</span></span><span style="display:flex;"><span>        ax<span style="color:#f92672">.</span>errorbar(future[<span style="color:#e6db74">&#39;Date&#39;</span>]<span style="color:#f92672">.</span>dt<span style="color:#f92672">.</span>to_pydatetime(), future[<span style="color:#e6db74">&#39;estimate&#39;</span>],
</span></span><span style="display:flex;"><span>                    yerr <span style="color:#f92672">=</span> future[<span style="color:#e6db74">&#39;upper&#39;</span>] <span style="color:#f92672">-</span> future[<span style="color:#e6db74">&#39;lower&#39;</span>],
</span></span><span style="display:flex;"><span>                    capthick<span style="color:#f92672">=</span><span style="color:#ae81ff">1.4</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;k&#39;</span>,linewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>,
</span></span><span style="display:flex;"><span>                   ecolor<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;darkblue&#39;</span>, capsize <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, elinewidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Pred with Range&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot formatting</span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(loc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>: <span style="color:#ae81ff">10</span>});
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xticks(rotation <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;45&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Predicted  Price (US $)&#39;</span>);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>); plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Predictions for </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">%</span> self<span style="color:#f92672">.</span>symbol);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">changepoint_prior_validation</span>(self, start_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>, end_date<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>,changepoint_priors <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0.001</span>, <span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.1</span>, <span style="color:#ae81ff">0.2</span>]):
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default start date is two years before end of data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Default end date is one year before end of data</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> start_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            start_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> end_date <span style="color:#f92672">is</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>            end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>max_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Convert to pandas datetime for indexing dataframe</span>
</span></span><span style="display:flex;"><span>        start_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(start_date)
</span></span><span style="display:flex;"><span>        end_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        start_date, end_date <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>handle_dates(start_date, end_date)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Select self.training_years number of years</span>
</span></span><span style="display:flex;"><span>        train <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;</span> (start_date <span style="color:#f92672">-</span> pd<span style="color:#f92672">.</span>DateOffset(years<span style="color:#f92672">=</span>self<span style="color:#f92672">.</span>training_years))) <span style="color:#f92672">&amp;</span>
</span></span><span style="display:flex;"><span>        (self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;</span> start_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Testing data is specified by range</span>
</span></span><span style="display:flex;"><span>        test <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>stock[(self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&gt;=</span> start_date) <span style="color:#f92672">&amp;</span> (self<span style="color:#f92672">.</span>stock[<span style="color:#e6db74">&#39;Date&#39;</span>] <span style="color:#f92672">&lt;=</span> end_date)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        eval_days <span style="color:#f92672">=</span> (max(test[<span style="color:#e6db74">&#39;Date&#39;</span>]) <span style="color:#f92672">-</span> min(test[<span style="color:#e6db74">&#39;Date&#39;</span>]))<span style="color:#f92672">.</span>days
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(<span style="color:#ae81ff">0</span>, index <span style="color:#f92672">=</span> list(range(len(changepoint_priors))),
</span></span><span style="display:flex;"><span>            columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;cps&#39;</span>, <span style="color:#e6db74">&#39;train_err&#39;</span>, <span style="color:#e6db74">&#39;train_range&#39;</span>, <span style="color:#e6db74">&#39;test_err&#39;</span>, <span style="color:#e6db74">&#39;test_range&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">Validation Range </span><span style="color:#e6db74">{}</span><span style="color:#e6db74"> to </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(min(test[<span style="color:#e6db74">&#39;Date&#39;</span>]),
</span></span><span style="display:flex;"><span>            max(test[<span style="color:#e6db74">&#39;Date&#39;</span>])))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Iterate through all the changepoints and make models</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i, prior <span style="color:#f92672">in</span> enumerate(changepoint_priors):
</span></span><span style="display:flex;"><span>            results[<span style="color:#e6db74">&#39;cps&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> prior
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Select the changepoint</span>
</span></span><span style="display:flex;"><span>            self<span style="color:#f92672">.</span>changepoint_prior_scale <span style="color:#f92672">=</span> prior
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Create and train a model with the specified cps</span>
</span></span><span style="display:flex;"><span>            model <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>create_model()
</span></span><span style="display:flex;"><span>            model<span style="color:#f92672">.</span>fit(train)
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>make_future_dataframe(periods<span style="color:#f92672">=</span>eval_days, freq<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;D&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            future <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(future)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Training results and metrics</span>
</span></span><span style="display:flex;"><span>            train_results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(train, future[[<span style="color:#e6db74">&#39;ds&#39;</span>, <span style="color:#e6db74">&#39;yhat&#39;</span>, <span style="color:#e6db74">&#39;yhat_upper&#39;</span>, <span style="color:#e6db74">&#39;yhat_lower&#39;</span>]], on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>            avg_train_error <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(abs(train_results[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">-</span> train_results[<span style="color:#e6db74">&#39;yhat&#39;</span>]))
</span></span><span style="display:flex;"><span>            avg_train_uncertainty <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(abs(train_results[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>] <span style="color:#f92672">-</span> train_results[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            results[<span style="color:#e6db74">&#39;train_err&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> avg_train_error
</span></span><span style="display:flex;"><span>            results[<span style="color:#e6db74">&#39;train_range&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> avg_train_uncertainty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e"># Testing results and metrics</span>
</span></span><span style="display:flex;"><span>            test_results <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>merge(test, future[[<span style="color:#e6db74">&#39;ds&#39;</span>, <span style="color:#e6db74">&#39;yhat&#39;</span>, <span style="color:#e6db74">&#39;yhat_upper&#39;</span>, <span style="color:#e6db74">&#39;yhat_lower&#39;</span>]], on <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;ds&#39;</span>, how <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span>            avg_test_error <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(abs(test_results[<span style="color:#e6db74">&#39;y&#39;</span>] <span style="color:#f92672">-</span> test_results[<span style="color:#e6db74">&#39;yhat&#39;</span>]))
</span></span><span style="display:flex;"><span>            avg_test_uncertainty <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(abs(test_results[<span style="color:#e6db74">&#39;yhat_upper&#39;</span>] <span style="color:#f92672">-</span> test_results[<span style="color:#e6db74">&#39;yhat_lower&#39;</span>]))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            results[<span style="color:#e6db74">&#39;test_err&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> avg_test_error
</span></span><span style="display:flex;"><span>            results[<span style="color:#e6db74">&#39;test_range&#39;</span>]<span style="color:#f92672">.</span>iloc[i] <span style="color:#f92672">=</span> avg_test_uncertainty
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        print(results)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot of training and testing average errors</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;train_err&#39;</span>], <span style="color:#e6db74">&#39;bo-&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Train Error&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;test_err&#39;</span>], <span style="color:#e6db74">&#39;r*-&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Test Error&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Changepoint Prior Scale&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Avg. Absolute Error ($)&#39;</span>);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Training and Testing Curves as Function of CPS&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>grid(color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;k&#39;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xticks(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;cps&#39;</span>])
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>:<span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Plot of training and testing average uncertainty</span>
</span></span><span style="display:flex;"><span>        self<span style="color:#f92672">.</span>reset_plot()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;train_range&#39;</span>], <span style="color:#e6db74">&#39;bo-&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Train Range&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>plot(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;test_range&#39;</span>], <span style="color:#e6db74">&#39;r*-&#39;</span>, ms <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>, label <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Test Range&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Changepoint Prior Scale&#39;</span>); plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Avg. Uncertainty ($)&#39;</span>);
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Uncertainty in Estimate as Function of CPS&#39;</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>grid(color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;k&#39;</span>, alpha<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>)
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>xticks(results[<span style="color:#e6db74">&#39;cps&#39;</span>], results[<span style="color:#e6db74">&#39;cps&#39;</span>])
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>legend(prop<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;size&#39;</span>:<span style="color:#ae81ff">10</span>})
</span></span><span style="display:flex;"><span>        plt<span style="color:#f92672">.</span>show();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 讀入資料</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;/content/DEXVZUS_out.csv&#39;</span>, index_col<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;ds&#39;</span>, parse_dates<span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;ds&#39;</span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 先用中位數補齊 NaN（每欄各自補自己的中位數）</span>
</span></span><span style="display:flex;"><span>df_filled <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>fillna(df<span style="color:#f92672">.</span>median(numeric_only<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 再執行 squeeze（若只有一欄，才會變成 Series）</span>
</span></span><span style="display:flex;"><span>price <span style="color:#f92672">=</span> df_filled<span style="color:#f92672">.</span>squeeze()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 檢查結果</span>
</span></span><span style="display:flex;"><span>print(price<span style="color:#f92672">.</span>tail())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DEXVZUS<span style="color:#f92672">=</span> Stocker(price)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model, model_data <span style="color:#f92672">=</span> DEXVZUS<span style="color:#f92672">.</span>create_prophet_model(days<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> )
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.preprocessing <span style="color:#f92672">import</span> MinMaxScaler
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.keras.models <span style="color:#f92672">import</span> Sequential
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> tensorflow.keras.layers <span style="color:#f92672">import</span> LSTM, Dense, Dropout
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#66d9ef">as</span> plt
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> matplotlib.dates <span style="color:#66d9ef">as</span> mdates
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Prepare data</span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#39;output.csv&#39;</span>)  <span style="color:#75715e"># Replace with your actual data loading method</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#39;DATE&#39;</span>] <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>to_datetime(df[<span style="color:#e6db74">&#39;DATE&#39;</span>])
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>rename(columns<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;DATE&#39;</span>: <span style="color:#e6db74">&#39;date&#39;</span>, <span style="color:#e6db74">&#39;value&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create lag features (滯後特徵)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_lag_features</span>(data, lag<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>    lagged_data <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">1</span>, lag<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>):
</span></span><span style="display:flex;"><span>        lagged_data[<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;lag_</span><span style="color:#e6db74">{</span>i<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>] <span style="color:#f92672">=</span> lagged_data[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>shift(i)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> lagged_data<span style="color:#f92672">.</span>dropna()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create lag features (加入前幾天的價格)</span>
</span></span><span style="display:flex;"><span>lag <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>  <span style="color:#75715e"># Use last 3 days to predict</span>
</span></span><span style="display:flex;"><span>df_lagged <span style="color:#f92672">=</span> create_lag_features(df, lag)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Scale the data</span>
</span></span><span style="display:flex;"><span>scaler <span style="color:#f92672">=</span> MinMaxScaler()
</span></span><span style="display:flex;"><span>values_scaled <span style="color:#f92672">=</span> scaler<span style="color:#f92672">.</span>fit_transform(df_lagged[<span style="color:#e6db74">&#39;value&#39;</span>]<span style="color:#f92672">.</span>values<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create sequences for LSTM</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_sequences</span>(data, seq_length):
</span></span><span style="display:flex;"><span>    X, y <span style="color:#f92672">=</span> [], []
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(len(data) <span style="color:#f92672">-</span> seq_length):
</span></span><span style="display:flex;"><span>        X<span style="color:#f92672">.</span>append(data[i:(i <span style="color:#f92672">+</span> seq_length)])
</span></span><span style="display:flex;"><span>        y<span style="color:#f92672">.</span>append(data[i <span style="color:#f92672">+</span> seq_length])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>array(X), np<span style="color:#f92672">.</span>array(y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create sequences</span>
</span></span><span style="display:flex;"><span>seq_length <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>  <span style="color:#75715e"># Using 12 months of data to predict next month</span>
</span></span><span style="display:flex;"><span>X, y <span style="color:#f92672">=</span> create_sequences(values_scaled, seq_length)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Split data into train and test sets</span>
</span></span><span style="display:flex;"><span>train_size <span style="color:#f92672">=</span> int(len(X) <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.8</span>)
</span></span><span style="display:flex;"><span>X_train, X_test <span style="color:#f92672">=</span> X[:train_size], X[train_size:]
</span></span><span style="display:flex;"><span>y_train, y_test <span style="color:#f92672">=</span> y[:train_size], y[train_size:]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Create the LSTM model with modified architecture</span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> Sequential([
</span></span><span style="display:flex;"><span>    LSTM(<span style="color:#ae81ff">50</span>, return_sequences<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, input_shape<span style="color:#f92672">=</span>(seq_length, <span style="color:#ae81ff">1</span>)),
</span></span><span style="display:flex;"><span>    Dropout(<span style="color:#ae81ff">0.3</span>),  <span style="color:#75715e"># Increased Dropout to avoid overfitting</span>
</span></span><span style="display:flex;"><span>    LSTM(<span style="color:#ae81ff">50</span>, return_sequences<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>),
</span></span><span style="display:flex;"><span>    Dropout(<span style="color:#ae81ff">0.3</span>),
</span></span><span style="display:flex;"><span>    Dense(<span style="color:#ae81ff">25</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>),
</span></span><span style="display:flex;"><span>    Dense(<span style="color:#ae81ff">1</span>, activation<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;relu&#39;</span>)  <span style="color:#75715e"># 使用 relu 確保輸出為正數</span>
</span></span><span style="display:flex;"><span>])
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Compile the model with different optimizer settings</span>
</span></span><span style="display:flex;"><span>model<span style="color:#f92672">.</span>compile(optimizer<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;adam&#39;</span>, loss<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mse&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Train the model with more epochs and validation split</span>
</span></span><span style="display:flex;"><span>history <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>fit(
</span></span><span style="display:flex;"><span>    X_train,
</span></span><span style="display:flex;"><span>    y_train,
</span></span><span style="display:flex;"><span>    epochs<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>,  <span style="color:#75715e"># Increased epochs for better training</span>
</span></span><span style="display:flex;"><span>    batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">32</span>,
</span></span><span style="display:flex;"><span>    validation_split<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>,
</span></span><span style="display:flex;"><span>    verbose<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Predict for 2025/1/8</span>
</span></span><span style="display:flex;"><span>future_date <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>Timestamp(<span style="color:#e6db74">&#39;2025-07-27&#39;</span>)
</span></span><span style="display:flex;"><span>last_sequence <span style="color:#f92672">=</span> values_scaled[<span style="color:#f92672">-</span>seq_length:]
</span></span><span style="display:flex;"><span>last_sequence <span style="color:#f92672">=</span> last_sequence<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">1</span>, seq_length, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>future_pred_scaled <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(last_sequence)
</span></span><span style="display:flex;"><span>future_pred <span style="color:#f92672">=</span> scaler<span style="color:#f92672">.</span>inverse_transform(future_pred_scaled)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Predicted value for 2025/1/8: $</span><span style="color:#e6db74">{</span>future_pred[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">:</span><span style="color:#e6db74">,.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Plot with enhanced date formatting</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">6</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(df[<span style="color:#e6db74">&#39;date&#39;</span>], df[<span style="color:#e6db74">&#39;value&#39;</span>], label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Actual Values&#39;</span>, marker<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;o&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>plot(future_date, future_pred[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;r*&#39;</span>, markersize<span style="color:#f92672">=</span><span style="color:#ae81ff">15</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Predicted Value&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Format x-axis to show dates in YYYY/MM/DD format</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>gca()<span style="color:#f92672">.</span>xaxis<span style="color:#f92672">.</span>set_major_formatter(mdates<span style="color:#f92672">.</span>DateFormatter(<span style="color:#e6db74">&#39;%Y/%m/</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>gcf()<span style="color:#f92672">.</span>autofmt_xdate()  <span style="color:#75715e"># Rotate and align the tick labels</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>title(<span style="color:#e6db74">&#39;Time Series Prediction&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#39;Date&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>ylabel(<span style="color:#e6db74">&#39;Value ($)&#39;</span>)
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>legend()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>grid(<span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Format y-axis to show dollar values</span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>gca()<span style="color:#f92672">.</span>yaxis<span style="color:#f92672">.</span>set_major_formatter(plt<span style="color:#f92672">.</span>FuncFormatter(<span style="color:#66d9ef">lambda</span> x, p: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;$</span><span style="color:#e6db74">{</span>x<span style="color:#e6db74">:</span><span style="color:#e6db74">,.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Predicted value for 2025/1/8: $</span><span style="color:#e6db74">{</span>future_pred[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>]<span style="color:#e6db74">:</span><span style="color:#e6db74">,.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Actual value: $369,980.57&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Absolute error: $</span><span style="color:#e6db74">{</span>abs(future_pred[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">369980.57</span>)<span style="color:#e6db74">:</span><span style="color:#e6db74">,.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Relative error: </span><span style="color:#e6db74">{</span>abs(future_pred[<span style="color:#ae81ff">0</span>][<span style="color:#ae81ff">0</span>] <span style="color:#f92672">-</span> <span style="color:#ae81ff">369980.57</span>)<span style="color:#f92672">/</span><span style="color:#ae81ff">369980.57</span><span style="color:#f92672">*</span><span style="color:#ae81ff">100</span><span style="color:#e6db74">:</span><span style="color:#e6db74">.2f</span><span style="color:#e6db74">}</span><span style="color:#e6db74">%&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>tight_layout()
</span></span><span style="display:flex;"><span>plt<span style="color:#f92672">.</span>show()
</span></span></code></pre></div>
        </div>

        
        <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "s0914712" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
  </div>
</section>



<footer class="text-capitalize">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://s0914712.github.io/"><img src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0912391259"><i
                class="ti-mobile mr-3 text-primary"></i>0912391259</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>US, Taiwan</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:s0914712@email.com"><i
                class="ti-email mr-3 text-primary"></i>s0914712@email.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="#">facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">instagram</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/ai%e8%a7%a3%e6%b1%ba%e8%bb%8d%e4%ba%8b%e5%95%8f%e9%a1%8c/">Ai解決軍事問題</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/history-and-taiwan/">History and taiwan</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/html-css/">HTML &amp; css</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/man-over-board-model/">Man over board model</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/about/">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/blog/">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/contact/">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="https://themefisher.com/hugo-themes/">Chen</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://s0914712.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://s0914712.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://s0914712.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://s0914712.github.io/plugins/slick/slick.min.js"></script>

<script src="https://s0914712.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://s0914712.github.io/plugins/search/fuse.min.js"></script>

<script src="https://s0914712.github.io/plugins/search/mark.js"></script>

<script src="https://s0914712.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://s0914712.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>