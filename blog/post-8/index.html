<!DOCTYPE html>
<html lang="en-us"><head>
  <meta charset="utf-8">
  <title>chen blog s091sdaf</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">
  <meta name="author" content="Jeremy Chen">
    
  
  <meta name="theme-name" content="liva-hugo" />
  
  <meta name="generator" content="Hugo 0.139.3">

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://s0914712.github.io/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://s0914712.github.io/scss/style.min.css" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://s0914712.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://s0914712.github.io/images/favicon.png " type="image/x-icon">


<script async src="https://www.googletagmanager.com/gtag/js?id=G-XFZRBQ7BCN"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-XFZRBQ7BCN');
</script>



</head>
<body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom pl-0">
      <a class="navbar-brand mobile-view" href="https://s0914712.github.io/"><img class="img-fluid"
          src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        <div class="desktop-view">
          <ul class="navbar-nav mr-auto">
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-facebook"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-twitter-alt"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-instagram"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-github"></i></a>
            </li>
            
            <li class="nav-item">
              <a class="nav-link" href="#"><i class="ti-linkedin"></i></a>
            </li>
            
          </ul>
        </div>

        <a class="navbar-brand mx-auto desktop-view" href="https://s0914712.github.io/"><img class="img-fluid"
            src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>

        <ul class="navbar-nav">
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/about/">About</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/blog/">Post</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://s0914712.github.io/contact/">Contact</a>
          </li>
          
          
        </ul>

        
        <!-- search -->
        <div class="search pl-lg-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://s0914712.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/categories/man-over-board-model"
          class="text-primary">Man over board model</a>
        
        <h2>從零開始建立人員落水軌跡預測模型(一)NETCDF檔案介紹</h2>
        <div class="mb-3 post-meta">
          <span>By Jeremy Chen</span>
          
          <span class="border-bottom border-primary px-2 mx-1"></span>
          <span>01 December 2024</span>
          
        </div>
        
        <img src="https://s0914712.github.io/images/post/MOB.jpg" class="img-fluid w-100 mb-4" alt="從零開始建立人員落水軌跡預測模型(一)NETCDF檔案介紹">
        
        <div class="content mb-5">
          <!-- raw HTML omitted -->
<h2 id="1-概述-what--why">1. 概述 (What &amp; Why)</h2>
<p>NetCDF 是一套為「科學陣列型資料」設計的 <strong>自描述 (self-describing)</strong>、<strong>跨平台 (portable)</strong>、<strong>可擴充 (extensible)</strong> 的資料模型與檔案格式，同時也包含一組 API 函式庫。典型應用領域包含：氣象、海洋、氣候、遙測、模式模擬（如大氣模式、海流、浪場）等。</p>
<h2 id="2-核心資料模型-classic-data-model">2. 核心資料模型 (Classic Data Model)</h2>
<table>
  <thead>
      <tr>
          <th>元素</th>
          <th>意義</th>
          <th>特點</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Dimension（維度）</strong></td>
          <td>定義陣列的軸長度與名稱，例如 <code>time</code>, <code>lat</code>, <code>lon</code>, <code>depth</code></td>
          <td>可標記一個為 <em>unlimited</em>（無界/可增長），常用於時間序列</td>
      </tr>
      <tr>
          <td><strong>Variable（變數）</strong></td>
          <td>具名的 N 維陣列，使用一組已定義維度，並附屬屬性</td>
          <td>儲存實際科學數值，如 <code>temperature(time, depth, lat, lon)</code></td>
      </tr>
      <tr>
          <td><strong>Attribute（屬性）</strong></td>
          <td>附掛在檔案 (global) 或變數上的「鍵值對」型 metadata</td>
          <td>描述單位、長描述、縮放係數、缺值等</td>
      </tr>
      <tr>
          <td><strong>Data（資料）</strong></td>
          <td>各變數的陣列值本體</td>
          <td>支援多種基本型別 (byte, char, short, int, float, double, int64, etc.)</td>
      </tr>
  </tbody>
</table>
<h2 id="3-netcdf-header-範例與逐行解釋">3. NetCDF Header 範例與逐行解釋</h2>
<h3 id="原始-header">原始 Header</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>netcdf example {
</span></span><span style="display:flex;"><span>  dimensions:
</span></span><span style="display:flex;"><span>    time = UNLIMITED ; // (10 currently)
</span></span><span style="display:flex;"><span>    lat = 181 ;
</span></span><span style="display:flex;"><span>    lon = 360 ;
</span></span><span style="display:flex;"><span>  variables:
</span></span><span style="display:flex;"><span>    double time(time) ;
</span></span><span style="display:flex;"><span>      time:units = &#34;hours since 2025-07-20 00:00:00&#34; ;
</span></span><span style="display:flex;"><span>      time:calendar = &#34;gregorian&#34; ;
</span></span><span style="display:flex;"><span>    float lat(lat) ;
</span></span><span style="display:flex;"><span>      lat:units = &#34;degrees_north&#34; ;
</span></span><span style="display:flex;"><span>    float lon(lon) ;
</span></span><span style="display:flex;"><span>      lon:units = &#34;degrees_east&#34; ;
</span></span><span style="display:flex;"><span>    float temperature(time, lat, lon) ;
</span></span><span style="display:flex;"><span>      temperature:long_name = &#34;Sea surface temperature&#34; ;
</span></span><span style="display:flex;"><span>      temperature:units = &#34;K&#34; ;
</span></span><span style="display:flex;"><span>      temperature:_FillValue = -9999.f ;
</span></span><span style="display:flex;"><span>      temperature:scale_factor = 0.01f ;
</span></span><span style="display:flex;"><span>      temperature:add_offset = 273.15f ;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  // global attributes:
</span></span><span style="display:flex;"><span>    :title = &#34;Demo SST&#34; ;
</span></span><span style="display:flex;"><span>    :history = &#34;2025-07-20T12:00:00Z created&#34; ;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="逐段說明">逐段說明</h3>
<h4 id="維度宣告">維度宣告</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>dimensions:
</span></span><span style="display:flex;"><span>  time = UNLIMITED ; // (10 currently)
</span></span><span style="display:flex;"><span>  lat = 181 ;
</span></span><span style="display:flex;"><span>  lon = 360 ;
</span></span></code></pre></div><ul>
<li>宣告 3 個維度：<code>time</code>、<code>lat</code>、<code>lon</code>。</li>
<li><code>time = UNLIMITED</code> 表示此維度可增長（appendable），目前已有 10 筆（索引 0..9）。</li>
<li><code>lat = 181</code>、<code>lon = 360</code> 為固定長度。例如：<code>lat</code> 可能為 -90 到 90（含端點，共 181 個點，步距 1°）；<code>lon</code> 可能為 0 到 359（共 360 個點）。</li>
</ul>
<h4 id="時間變數">時間變數</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>double time(time) ;
</span></span><span style="display:flex;"><span>  time:units = &#34;hours since 2025-07-20 00:00:00&#34; ;
</span></span><span style="display:flex;"><span>  time:calendar = &#34;gregorian&#34; ;
</span></span></code></pre></div><ul>
<li><code>time(time)</code>：1 維時間座標變數。</li>
<li><code>units</code> 採 CF 規範：「<code>&lt;時間單位&gt; since &lt;參考時間&gt;</code>」。此處表示「自 2025-07-20 00:00:00 起算的小時數」。
<ul>
<li>例：<code>time[0] = 0</code> → 2025-07-20 00:00</li>
<li><code>time[1] = 6</code> → 2025-07-20 06:00</li>
</ul>
</li>
<li><code>calendar=&quot;gregorian&quot;</code> 指定日曆系統。</li>
</ul>
<h4 id="經緯度座標變數">經緯度座標變數</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>float lat(lat) ;
</span></span><span style="display:flex;"><span>  lat:units = &#34;degrees_north&#34; ;
</span></span><span style="display:flex;"><span>float lon(lon) ;
</span></span><span style="display:flex;"><span>  lon:units = &#34;degrees_east&#34; ;
</span></span></code></pre></div><ul>
<li>座標變數（coordinate variables）：名稱與維度相同。</li>
<li>提供每個格點的地理位置（緯度、經度）。</li>
</ul>
<h4 id="資料變數">資料變數</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>float temperature(time, lat, lon) ;
</span></span><span style="display:flex;"><span>  temperature:long_name = &#34;Sea surface temperature&#34; ;
</span></span><span style="display:flex;"><span>  temperature:units = &#34;K&#34; ;
</span></span><span style="display:flex;"><span>  temperature:_FillValue = -9999.f ;
</span></span><span style="display:flex;"><span>  temperature:scale_factor = 0.01f ;
</span></span><span style="display:flex;"><span>  temperature:add_offset = 273.15f ;
</span></span></code></pre></div><ul>
<li><code>temperature</code> 為 3 維資料：<code>time × lat × lon</code>。</li>
<li>使用「打包（packed）」策略：以 <code>scale_factor</code> 與 <code>add_offset</code> 壓縮存放範圍。
<ul>
<li>解碼：<code>physical_value = scale_factor * stored_value + add_offset</code>。</li>
<li>例：<code>stored = 2000</code> → <code>0.01 * 2000 + 273.15 = 293.15 K</code>。</li>
</ul>
</li>
<li><code>_FillValue = -9999.f</code>：缺值標記；讀取後通常轉換為 <code>NaN</code>。</li>
<li><code>long_name</code> 與 <code>units</code> 為語意與顯示用 metadata。</li>
</ul>
<h4 id="全域屬性">全域屬性</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>:title = &#34;Demo SST&#34; ;
</span></span><span style="display:flex;"><span>:history = &#34;2025-07-20T12:00:00Z created&#34; ;
</span></span></code></pre></div><ul>
<li><code>title</code>：檔案標題。</li>
<li><code>history</code>：處理沿革；每次加工可附加一段（建議包含時間戳與動作）。</li>
</ul>
<hr>
<h2 id="4-對應速查">4. 對應速查</h2>
<table>
  <thead>
      <tr>
          <th>區塊</th>
          <th>重點</th>
          <th>補充</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>dimensions</td>
          <td>定義各軸大小，<code>UNLIMITED</code> 允許追加</td>
          <td>一檔可有 0 或多個 unlimited（建議僅 1 個）</td>
      </tr>
      <tr>
          <td>time 變數</td>
          <td>時間軸與日曆</td>
          <td>使用 CF 規範「units + calendar」</td>
      </tr>
      <tr>
          <td>lat/lon</td>
          <td>空間座標</td>
          <td>可搭配 <code>standard_name=&quot;latitude&quot;</code> 等</td>
      </tr>
      <tr>
          <td>temperature</td>
          <td>主資料陣列</td>
          <td>打包機制節省空間</td>
      </tr>
      <tr>
          <td>global attributes</td>
          <td>整體描述與追溯</td>
          <td><code>history</code> 建議 ISO 8601</td>
      </tr>
  </tbody>
</table>
<h2 id="5-packed-value-解碼範例python">5. Packed value 解碼範例（Python）</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>physical <span style="color:#f92672">=</span> scale_factor <span style="color:#f92672">*</span> stored <span style="color:#f92672">+</span> add_offset
</span></span><span style="display:flex;"><span>physical[stored <span style="color:#f92672">==</span> fill_value] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>nan
</span></span></code></pre></div><hr>
<blockquote>
<p>需要再擴充成 CF Conventions 教學、或輸出成 PDF / Word 版本，可再告訴我。</p>
</blockquote>
<hr>
<h2 id="6-使用-xarray-讀取與操作-netcdf">6. 使用 xarray 讀取與操作 NetCDF</h2>
<p>以下示範使用 <code>xarray</code>（結合 <code>netCDF4</code> 或 <code>h5netcdf</code> 後端）讀取、檢視、分析與寫回 NetCDF 的典型流程。</p>
<h3 id="61-安裝">6.1 安裝</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>pip install xarray netCDF4 cftime dask<span style="color:#f92672">[</span>complete<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 若需要壓縮或平行最佳化，可再安裝 zarr, h5netcdf 等</span>
</span></span></code></pre></div><h3 id="62-基本開檔">6.2 基本開檔</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> xarray <span style="color:#66d9ef">as</span> xr
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ds <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_dataset(<span style="color:#e6db74">&#39;example.nc&#39;</span>)  <span style="color:#75715e"># 延遲讀取 (lazy)；僅讀 header/metadata</span>
</span></span><span style="display:flex;"><span>print(ds)                            <span style="color:#75715e"># 類似 ncdump -h + 變數概觀</span>
</span></span></code></pre></div><blockquote>
<p><code>open_dataset</code> 預設是 lazy：真正的資料直到運算或 <code>.load()</code> 才讀入記憶體。</p>
</blockquote>
<h3 id="63-取出變數與座標">6.3 取出變數與座標</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>t <span style="color:#f92672">=</span> ds[<span style="color:#e6db74">&#39;temperature&#39;</span>]      <span style="color:#75715e"># DataArray</span>
</span></span><span style="display:flex;"><span>lat <span style="color:#f92672">=</span> ds[<span style="color:#e6db74">&#39;lat&#39;</span>]
</span></span><span style="display:flex;"><span>lon <span style="color:#f92672">=</span> ds[<span style="color:#e6db74">&#39;lon&#39;</span>]
</span></span><span style="display:flex;"><span>print(t<span style="color:#f92672">.</span>dims, t<span style="color:#f92672">.</span>shape)     <span style="color:#75715e"># (&#39;time&#39;,&#39;lat&#39;,&#39;lon&#39;), (10,181,360)</span>
</span></span></code></pre></div><h3 id="64-自動解碼時間scale_factor-與缺值">6.4 自動解碼時間、scale_factor 與缺值</h3>
<p>xarray 預設會依 CF Conventions 自動：</p>
<ul>
<li>將 <code>time</code> 轉為 <code>datetime64</code> 或 <code>cftime</code> 物件。</li>
<li>套用 <code>scale_factor</code> / <code>add_offset</code>。</li>
<li>將 <code>_FillValue</code>/<code>missing_value</code> 轉為 <code>NaN</code>。</li>
</ul>
<p>可停用：<code>xr.open_dataset('example.nc', decode_times=False, mask_and_scale=False)</code>。</p>
<h3 id="65-選取與切片">6.5 選取與切片</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 依座標值切片（最近鄰或對齊）</span>
</span></span><span style="display:flex;"><span>subset <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>sel(time<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;2025-07-20T06:00:00&#39;</span>, lat<span style="color:#f92672">=</span>slice(<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">10</span>), lon<span style="color:#f92672">=</span>slice(<span style="color:#ae81ff">120</span>,<span style="color:#ae81ff">150</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 依索引切片</span>
</span></span><span style="display:flex;"><span>t0 <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>isel(time<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
</span></span></code></pre></div><h3 id="66-計算懶加速">6.6 計算（懶加速）</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 平均一段時間與空間（仍 lazy）</span>
</span></span><span style="display:flex;"><span>mean_equatorial <span style="color:#f92672">=</span> t<span style="color:#f92672">.</span>sel(lat<span style="color:#f92672">=</span>slice(<span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>))<span style="color:#f92672">.</span>mean(dim<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#39;time&#39;</span>,<span style="color:#e6db74">&#39;lat&#39;</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 觸發實際計算</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> mean_equatorial<span style="color:#f92672">.</span>compute()  <span style="color:#75715e"># 或 .load()</span>
</span></span></code></pre></div><blockquote>
<p>若安裝與設定 Dask，xarray 會自動用 Dask array，便於大檔案平行/分塊運算。</p>
</blockquote>
<h3 id="67-設定-chunk適合大檔案">6.7 設定 Chunk（適合大檔案）</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ds <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_dataset(<span style="color:#e6db74">&#39;example.nc&#39;</span>, chunks<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;time&#39;</span>: <span style="color:#ae81ff">50</span>})
</span></span></code></pre></div><ul>
<li><code>chunks</code> 對應 Dask 分塊大小；與 NetCDF chunk 不同，但影響執行時分佈計算。</li>
<li>建議 time 維度 chunk 為常用分析窗口倍數。</li>
</ul>
<h3 id="68-多檔拼接-concatenation-與合併">6.8 多檔拼接 (Concatenation) 與合併</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 多檔沿 time 座標自動串接</span>
</span></span><span style="display:flex;"><span>ds_all <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_mfdataset(<span style="color:#e6db74">&#39;var_2025_0*.nc&#39;</span>, combine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;by_coords&#39;</span>, parallel<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>                           data_vars<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;minimal&#39;</span>, coords<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;minimal&#39;</span>, compat<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;override&#39;</span>)
</span></span></code></pre></div><p>常見參數：</p>
<table>
  <thead>
      <tr>
          <th>參數</th>
          <th>作用</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>combine='by_coords'</code></td>
          <td>依座標值（如 time）對齊拼接</td>
      </tr>
      <tr>
          <td><code>parallel=True</code></td>
          <td>啟用 Dask 平行</td>
      </tr>
      <tr>
          <td><code>data_vars='minimal'</code></td>
          <td>避免重複合併變數屬性衝突</td>
      </tr>
      <tr>
          <td><code>compat='override'</code></td>
          <td>屬性衝突時採第一份</td>
      </tr>
  </tbody>
</table>
<h3 id="69-去除重複時間與排序">6.9 去除重複時間與排序</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#e6db74">&#39;time&#39;</span> <span style="color:#f92672">in</span> ds_all<span style="color:#f92672">.</span>coords:
</span></span><span style="display:flex;"><span>    ds_all <span style="color:#f92672">=</span> ds_all<span style="color:#f92672">.</span>sortby(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span>    _, idx <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>unique(ds_all<span style="color:#f92672">.</span>time, return_index<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> len(idx) <span style="color:#f92672">!=</span> ds_all<span style="color:#f92672">.</span>sizes[<span style="color:#e6db74">&#39;time&#39;</span>]:
</span></span><span style="display:flex;"><span>        ds_all <span style="color:#f92672">=</span> ds_all<span style="color:#f92672">.</span>isel(time<span style="color:#f92672">=</span>idx<span style="color:#f92672">.</span>sortby(idx))
</span></span></code></pre></div><h3 id="610-加入新計算結果">6.10 加入新計算結果</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>ds_all[<span style="color:#e6db74">&#39;temp_anomaly&#39;</span>] <span style="color:#f92672">=</span> ds_all<span style="color:#f92672">.</span>temperature <span style="color:#f92672">-</span> ds_all<span style="color:#f92672">.</span>temperature<span style="color:#f92672">.</span>mean(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span></code></pre></div><blockquote>
<p>新增的 <code>DataArray</code> 會自動繼承對齊座標。</p>
</blockquote>
<h3 id="611-寫回-netcdf">6.11 寫回 NetCDF</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>encoding <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;temperature&#39;</span>: {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;zlib&#39;</span>: <span style="color:#66d9ef">True</span>, <span style="color:#e6db74">&#39;complevel&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;shuffle&#39;</span>: <span style="color:#66d9ef">True</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># 指定 chunksizes (影響最終 NetCDF 物理 chunk)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;chunksizes&#39;</span>: (<span style="color:#ae81ff">50</span>, ds_all<span style="color:#f92672">.</span>dims[<span style="color:#e6db74">&#39;lat&#39;</span>], ds_all<span style="color:#f92672">.</span>dims[<span style="color:#e6db74">&#39;lon&#39;</span>])
</span></span><span style="display:flex;"><span>    },
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;temp_anomaly&#39;</span>: {<span style="color:#e6db74">&#39;zlib&#39;</span>: <span style="color:#66d9ef">True</span>, <span style="color:#e6db74">&#39;complevel&#39;</span>: <span style="color:#ae81ff">4</span>, <span style="color:#e6db74">&#39;shuffle&#39;</span>: <span style="color:#66d9ef">True</span>}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ds_all<span style="color:#f92672">.</span>to_netcdf(<span style="color:#e6db74">&#39;merged_with_anomaly.nc&#39;</span>, encoding<span style="color:#f92672">=</span>encoding)
</span></span></code></pre></div><p>注意：</p>
<ul>
<li><code>chunksizes</code> 是寫入 NetCDF 物理 chunk（與 <code>open_dataset(..., chunks=...)</code> 的記憶體分塊不同）。</li>
<li>設定壓縮層級 1–6 通常平衡速度與壓縮比。</li>
</ul>
<h3 id="612-與-pandas-互動">6.12 與 Pandas 互動</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 取某經緯點時間序列，轉為 Pandas Series</span>
</span></span><span style="display:flex;"><span>pt_series <span style="color:#f92672">=</span> ds_all<span style="color:#f92672">.</span>temperature<span style="color:#f92672">.</span>sel(lat<span style="color:#f92672">=</span><span style="color:#ae81ff">0.0</span>, lon<span style="color:#f92672">=</span><span style="color:#ae81ff">140.0</span>, method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;nearest&#39;</span>)
</span></span><span style="display:flex;"><span>ser <span style="color:#f92672">=</span> pt_series<span style="color:#f92672">.</span>to_pandas()
</span></span></code></pre></div><h3 id="613-常見錯誤排查">6.13 常見錯誤排查</h3>
<table>
  <thead>
      <tr>
          <th>情況</th>
          <th>原因</th>
          <th>解法</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>ValueError: conflicting sizes for dimension 'time'</code></td>
          <td>多檔 time 維度無法對齊</td>
          <td>改用 <code>combine='nested'</code> + 手動指定 <code>concat_dim</code> 或檢查時間座標值</td>
      </tr>
      <tr>
          <td>時間無法解析 (NaT)</td>
          <td>calendar 不支援 <code>datetime64</code></td>
          <td>使用 <code>xr.open_dataset(..., use_cftime=True)</code></td>
      </tr>
      <tr>
          <td>記憶體不足</td>
          <td><code>.load()</code> 讀入太大</td>
          <td>保持 lazy，使用 <code>.compute()</code> 只在需要時觸發；調整 <code>chunks</code></td>
      </tr>
      <tr>
          <td>運算很慢</td>
          <td>chunk 不佳或過多小檔</td>
          <td>重新設定 chunk；先用 NCO/CDO 合併減少檔案數</td>
      </tr>
  </tbody>
</table>
<h3 id="614-快速範例從讀到分析再輸出">6.14 快速範例（從讀到分析再輸出）</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> xarray <span style="color:#66d9ef">as</span> xr
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1. 讀多檔</span>
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;var_2025_0*.nc&#39;</span>
</span></span><span style="display:flex;"><span>ds <span style="color:#f92672">=</span> xr<span style="color:#f92672">.</span>open_mfdataset(files, combine<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;by_coords&#39;</span>, chunks<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;time&#39;</span>: <span style="color:#ae81ff">48</span>})
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 時間排序</span>
</span></span><span style="display:flex;"><span>ds <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>sortby(<span style="color:#e6db74">&#39;time&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 計算季平均 (假設 time 是 hourly 資料)</span>
</span></span><span style="display:flex;"><span>season_mean <span style="color:#f92672">=</span> ds<span style="color:#f92672">.</span>temperature<span style="color:#f92672">.</span>resample(time<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;3M&#39;</span>)<span style="color:#f92672">.</span>mean()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4. 儲存結果</span>
</span></span><span style="display:flex;"><span>season_mean<span style="color:#f92672">.</span>to_netcdf(<span style="color:#e6db74">&#39;temperature_3M_mean.nc&#39;</span>)
</span></span></code></pre></div><h3 id="615-小抄-cheat-sheet">6.15 小抄 (Cheat Sheet)</h3>
<table>
  <thead>
      <tr>
          <th>任務</th>
          <th>做法</th>
          <th>備註</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>開檔</td>
          <td><code>xr.open_dataset()</code></td>
          <td>lazy, metadata only</td>
      </tr>
      <tr>
          <td>多檔</td>
          <td><code>xr.open_mfdataset()</code></td>
          <td>自動拼接座標</td>
      </tr>
      <tr>
          <td>選取</td>
          <td><code>.sel()</code> / <code>.isel()</code></td>
          <td>值 vs 索引</td>
      </tr>
      <tr>
          <td>聚合</td>
          <td><code>.mean() .sum() .resample()</code></td>
          <td>支援多維</td>
      </tr>
      <tr>
          <td>新變數</td>
          <td><code>ds['new']=...</code></td>
          <td>座標自動對齊</td>
      </tr>
      <tr>
          <td>寫檔</td>
          <td><code>.to_netcdf(encoding=...)</code></td>
          <td>控制壓縮/chunk</td>
      </tr>
      <tr>
          <td>去重</td>
          <td><code>xr.unique</code> + <code>isel</code></td>
          <td>需排序先</td>
      </tr>
      <tr>
          <td>時間重抽樣</td>
          <td><code>.resample(time='D').mean()</code></td>
          <td>需時間為 datetime 類型</td>
      </tr>
      <tr>
          <td>轉 Pandas</td>
          <td><code>.to_pandas()</code></td>
          <td>只適用 1D 座標</td>
      </tr>
  </tbody>
</table>
<hr>
<blockquote>
<p>若需要：我可以再加上 <strong>Zarr 雲端存取流程</strong>、<strong>平行 Dask 設定</strong> 或 <strong>CF 規範標準名稱補充</strong>，告訴我即可。</p>
</blockquote>

        </div>

        
        <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "s0914712" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </div>
    </div>
  </div>
</section>



<footer class="text-capitalize">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 text-center mb-5">
        <a href="https://s0914712.github.io/"><img src="https://s0914712.github.io/images/logo.jpg" alt="chen blog s091sdaf"></a>
      </div>
               
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="tel:0912391259"><i
                class="ti-mobile mr-3 text-primary"></i>0912391259</a></li>
          
                     
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>US, Taiwan</li>
          
                     
          <li class="mb-3"><a class="text-dark" href="mailto:s0914712@email.com"><i
                class="ti-email mr-3 text-primary"></i>s0914712@email.com</a>
          
          </li>
        </ul>
      </div>
      
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="#">facebook</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">instagram</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="#">linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/categories/ai%e8%a7%a3%e6%b1%ba%e8%bb%8d%e4%ba%8b%e5%95%8f%e9%a1%8c/">Ai解決軍事問題</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/history-and-taiwan/">History and taiwan</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/html-css/">HTML &amp; css</a>
          </li>
          <li class="mb-3"><a class="text-dark"
              href="/categories/man-over-board-model/">Man over board model</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/about/">About</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/blog/">Post</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://s0914712.github.io/contact/">Contact</a></li>
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | copyright © 2021 <a href="https://themefisher.com/hugo-themes/">Chen</a> All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://s0914712.github.io/index.json"
</script>

<!-- JS Plugins -->

<script src="https://s0914712.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://s0914712.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://s0914712.github.io/plugins/slick/slick.min.js"></script>

<script src="https://s0914712.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://s0914712.github.io/plugins/search/fuse.min.js"></script>

<script src="https://s0914712.github.io/plugins/search/mark.js"></script>

<script src="https://s0914712.github.io/plugins/search/search.js"></script>

<!-- Main Script -->

<script src="https://s0914712.github.io/js/script.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.2.1/js.cookie.min.js"></script>
<div id="js-cookie-box" class="cookie-box cookie-box-hide">
	This site uses cookies. By continuing to use this website, you agree to their use. <span id="js-cookie-button" class="btn btn-sm btn-primary ml-2">I Accept</span>
</div>
<script>
	(function ($) {
		const cookieBox = document.getElementById('js-cookie-box');
		const cookieButton = document.getElementById('js-cookie-button');
		if (!Cookies.get('cookie-box')) {
			cookieBox.classList.remove('cookie-box-hide');
			cookieButton.onclick = function () {
				Cookies.set('cookie-box', true, {
					expires:  2 
				});
				cookieBox.classList.add('cookie-box-hide');
			};
		}
	})(jQuery);
</script>


<style>
.cookie-box {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  text-align: center;
  z-index: 9999;
  padding: 1rem 2rem;
  background: rgb(71, 71, 71);
  transition: all .75s cubic-bezier(.19, 1, .22, 1);
  color: #fdfdfd;
}

.cookie-box-hide {
  display: none;
}
</style>
</body>
</html>